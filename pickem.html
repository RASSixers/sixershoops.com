<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pick'em ‚Äî Daily NBA Predictions & Leaderboards</title>
  <meta name="description" content="Make your daily NBA picks, compete with others, and climb the leaderboards in Pick'em." />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/favicon.ico" />
  <link rel="stylesheet" href="navbar-styles.css">
  <!-- Firebase SDK (Compat version for better compatibility) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8055761449140377"
       crossorigin="anonymous"></script>
  <!-- Google Analytics 4 (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T1V9Q0MNEM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-T1V9Q0MNEM');
  </script>
  <style>
    :root {
      --ink: #0f172a;
      --muted: #475569;
      --border: rgba(15, 23, 42, 0.12);
      --bg: #fafafa;
      --white: #ffffff;
      --brand: #003da6;
      --accent: #e11d48;
      --chip: #eef2ff;
      --success: #10b981;
      --error: #ef4444;
    }

    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; }
    body {
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink);
      background: linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
      line-height: 1.55;
      padding-top: 72px;
    }

    .main-container { max-width: 1200px; margin: 0 auto; padding: 2rem; }

    .page-header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding: 5rem 2rem;
      background: transparent;
      color: var(--ink);
      position: relative;
      overflow: hidden;
    }

    .page-title {
      font-size: 3.5rem;
      font-weight: 900;
      margin-bottom: 1rem;
      color: var(--ink);
    }

    .page-title .highlight {
      color: #003da6;
    }

    .page-subtitle {
      font-size: 1.25rem;
      color: #64748b;
      font-weight: 500;
      max-width: 600px;
      margin: 0 auto;
    }

    .info-section {
      padding: 2rem;
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--border);
      margin-bottom: 3rem;
      box-shadow: 0 4px 12px rgba(2, 6, 23, 0.04);
    }

    .info-content {
      max-width: 800px;
      margin: 0 auto;
    }

    .info-content h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--brand);
      margin-bottom: 1rem;
      margin-top: 0;
    }

    .info-content p {
      color: #64748b;
      line-height: 1.6;
      margin-bottom: 1rem;
    }

    .info-content ul {
      color: #64748b;
      line-height: 1.8;
      margin-bottom: 0;
      padding-left: 1.5rem;
    }

    .info-content li {
      margin-bottom: 0.5rem;
    }

    /* Auth Section */
    .auth-section {
      max-width: 600px;
      margin: 3rem auto;
      background: var(--white);
      border-radius: 16px;
      border: 2px solid var(--brand);
      overflow: hidden;
      box-shadow: 0 10px 28px rgba(2, 6, 23, 0.06);
      position: relative;
    }

    .auth-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--brand), var(--accent), var(--brand));
    }

    .auth-header-section {
      padding: 2rem;
      background: linear-gradient(135deg, rgba(0, 61, 166, 0.08), rgba(225, 29, 72, 0.04));
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    .auth-title {
      font-size: 2rem;
      font-weight: 900;
      color: var(--brand);
      margin: 0 0 0.5rem 0;
      letter-spacing: -0.02em;
    }

    .auth-subtitle {
      font-size: 0.95rem;
      color: var(--muted);
      margin: 0;
      font-weight: 600;
    }

    .auth-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }

    .auth-tab-btn {
      flex: 1;
      padding: 16px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-weight: 700;
      cursor: pointer;
      transition: all .2s ease;
      text-transform: uppercase;
      letter-spacing: .06em;
      font-size: 13px;
    }

    .auth-tab-btn.active {
      color: var(--brand);
      background: var(--chip);
      border-bottom: 3px solid var(--brand);
    }

    .auth-form-content {
      padding: 2rem;
      background: linear-gradient(to bottom, var(--white), #fafafa);
    }

    .auth-form-content.hidden {
      display: none;
    }

    #registerForm::before {
      content: 'Ready to compete? Create your account below';
      display: block;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: linear-gradient(135deg, rgba(0, 61, 166, 0.05), rgba(225, 29, 72, 0.02));
      border-left: 4px solid var(--brand);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--ink);
      text-align: left;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 700;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--muted);
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      transition: all .2s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(0, 61, 166, 0.1);
    }

    .error-text {
      display: block;
      font-size: 12px;
      color: var(--error);
      margin-top: 4px;
      font-weight: 600;
    }

    .forgot-password-btn {
      background: none;
      border: none;
      color: var(--brand);
      text-decoration: none;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .forgot-password-btn:hover {
      color: #1e3a8a;
    }

    .auth-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .user-welcome {
      font-weight: 700;
      color: var(--ink);
    }

    .user-badge {
      display: inline-block;
      background: var(--chip);
      color: var(--brand);
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
    }

    .logout-btn {
      padding: 8px 16px;
      background: var(--error);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      transition: all .2s ease;
    }

    .logout-btn:hover {
      opacity: 0.9;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 2rem;
      border-bottom: 2px solid var(--border);
      overflow-x: auto;
      padding-bottom: 0;
    }

    .tab-btn {
      padding: 12px 24px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all .2s ease;
      white-space: nowrap;
    }

    .tab-btn:hover { color: var(--brand); }
    .tab-btn.active {
      color: var(--brand);
      border-bottom-color: var(--brand);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .questions-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 2rem;
      min-height: 200px;
    }

    .loading-state, .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      font-size: 16px;
      color: var(--text-muted, #666);
      background: rgba(0, 0, 0, 0.02);
      border-radius: 16px;
      border: 1px solid var(--border);
    }

    .loading-state {
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .question-card {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 28px rgba(2, 6, 23, 0.06);
      transition: all .2s ease;
    }

    .question-card:hover {
      box-shadow: 0 16px 40px rgba(2, 6, 23, 0.1);
      transform: translateY(-2px);
    }

    .question-card.answered {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.03), rgba(16, 185, 129, 0.05));
    }

    .question-number {
      font-size: 12px;
      font-weight: 900;
      color: var(--brand);
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: 8px;
    }

    .question-text {
      font-size: 18px;
      font-weight: 900;
      margin-bottom: 20px;
      color: var(--ink);
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .option {
      appearance: none;
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      background: var(--white);
      color: var(--ink);
      font-weight: 700;
      cursor: pointer;
      transition: all .15s ease;
    }

    .option:hover {
      border-color: var(--brand);
      background: var(--chip);
    }

    .option:checked {
      border-color: var(--brand);
      background: linear-gradient(135deg, #e0e7ff, #f0f4ff);
      color: var(--brand);
    }

    .radio-option, .checkbox-option {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .radio-option input, .checkbox-option input {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--brand);
    }

    .text-input {
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 700;
      font-size: 16px;
      transition: all .15s ease;
      width: 100%;
    }

    .text-input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(0, 61, 166, 0.1);
    }

    .date-picker-container {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 2rem;
      overflow-x: auto;
      padding: 12px 0;
      scroll-behavior: smooth;
    }

    .date-picker-btn {
      background: var(--white);
      border: 2px solid var(--border);
      padding: 12px 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      font-weight: 600;
      font-size: 13px;
      min-width: 90px;
      text-align: center;
    }

    .date-picker-btn:hover {
      border-color: var(--brand);
      background: var(--chip);
    }

    .date-picker-btn.active {
      background: linear-gradient(135deg, var(--brand), #1e3a8a);
      color: white;
      border-color: var(--brand);
    }

    .date-picker-btn.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .date-picker-date {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 2px;
    }

    .date-slider-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .date-nav-btn {
      background: var(--white);
      border: 2px solid var(--border);
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--brand);
      font-weight: bold;
    }

    .date-nav-btn:hover {
      background: var(--chip);
      border-color: var(--brand);
    }

    .date-nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .submit-section {
      display: flex;
      gap: 12px;
      margin-bottom: 2rem;
    }

    .btn {
      padding: 12px 32px;
      border: none;
      border-radius: 12px;
      font-weight: 900;
      font-size: 14px;
      cursor: pointer;
      transition: all .2s ease;
      text-transform: uppercase;
      letter-spacing: .06em;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--brand), #1e3a8a);
      color: white;
      flex: 1;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(0, 61, 166, 0.3);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-signup {
      background: linear-gradient(135deg, var(--accent), #be123c) !important;
      font-size: 15px !important;
      font-weight: 900 !important;
      letter-spacing: 0.05em !important;
      position: relative;
      overflow: hidden;
    }

    .btn-signup:hover {
      box-shadow: 0 16px 32px rgba(225, 29, 72, 0.4) !important;
      transform: translateY(-3px) !important;
    }

    .btn-secondary {
      background: var(--white);
      color: var(--brand);
      border: 2px solid var(--brand);
    }

    .btn-secondary:hover {
      background: var(--chip);
    }

    .leaderboard-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--white);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
      box-shadow: 0 10px 28px rgba(2, 6, 23, 0.06);
    }

    .leaderboard-table thead th {
      background: #f8fafc;
      padding: 16px 20px;
      text-align: left;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--muted);
      font-weight: 900;
      border-bottom: 1px solid var(--border);
    }

    .leaderboard-table tbody td {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      font-weight: 700;
    }

    .leaderboard-table tbody tr:last-child td {
      border-bottom: none;
    }

    .leaderboard-table tbody tr:hover td {
      background: #fafcff;
    }

    .rank {
      color: var(--brand);
      font-weight: 900;
      font-size: 16px;
    }

    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      font-weight: 900;
      color: white;
      margin-right: 8px;
    }

    .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
    .rank-2 { background: linear-gradient(135deg, #d1d5db, #9ca3af); }
    .rank-3 { background: linear-gradient(135deg, #fdba74, #fb923c); }

    .score {
      color: var(--success);
      font-weight: 900;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--muted);
    }

    .message {
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-weight: 700;
      display: none;
    }

    .message.show {
      display: block;
    }

    .message.success {
      background: rgba(16, 185, 129, 0.1);
      color: #065f46;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .message.error {
      background: rgba(239, 68, 68, 0.1);
      color: #7f1d1d;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--brand), var(--accent));
      width: 0%;
      transition: width .3s ease;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(2, 6, 23, 0.04);
    }

    .stat-value {
      font-size: 28px;
      font-weight: 900;
      color: var(--brand);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: var(--muted);
      font-weight: 900;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--muted);
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--border);
      border-top-color: var(--brand);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Admin Panel Styles */
    .admin-panel {
      max-width: 900px;
      margin: 0 auto;
    }

    .admin-panel h2 {
      margin-bottom: 2rem;
      color: var(--brand);
    }

    .admin-panel h3 {
      margin-top: 2rem;
      margin-bottom: 1.5rem;
      color: var(--ink);
      font-size: 1.1rem;
    }

    .admin-date-section {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      align-items: center;
      background: var(--chip);
      padding: 1rem;
      border-radius: 12px;
    }

    .admin-date-section label {
      font-weight: 700;
      color: var(--ink);
    }

    .admin-date-section input {
      padding: 8px 12px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
    }

    .admin-form {
      background: var(--white);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .admin-questions-list {
      background: var(--white);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 2rem;
    }

    .admin-question-item {
      background: var(--chip);
      border-left: 4px solid var(--brand);
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .admin-question-item-content {
      flex: 1;
    }

    .admin-question-item-text {
      font-weight: 700;
      color: var(--ink);
      margin-bottom: 0.5rem;
    }

    .admin-question-item-type {
      font-size: 13px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .06em;
    }

    .admin-question-item-options {
      font-size: 13px;
      color: var(--muted);
      margin-top: 0.5rem;
    }

    .admin-question-item-actions {
      display: flex;
      gap: 0.5rem;
    }

    .admin-question-item-actions button {
      padding: 6px 12px;
      font-size: 13px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all .2s ease;
      font-weight: 700;
    }

    .admin-delete-btn {
      background: var(--error);
      color: white;
    }

    .admin-delete-btn:hover {
      opacity: 0.9;
    }

    @media (max-width: 768px) {
      .page-title { font-size: 2rem; }
      .questions-container { grid-template-columns: 1fr; }
      .tabs { padding-bottom: 12px; }
      .submit-section { flex-direction: column; }
      .leaderboard-table { font-size: 14px; }
      .leaderboard-table thead th,
      .leaderboard-table tbody td { padding: 12px 16px; }
      .auth-header { flex-direction: column; gap: 1rem; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Login/Register Section -->
    <div id="authContainer" class="auth-section" style="display: none;">
      <div class="auth-header-section">
        <h2 class="auth-title">Pick'em</h2>
        <p class="auth-subtitle">NBA Daily Predictions Competition - Make Your Picks & Compete</p>
      </div>
      <div class="auth-tabs">
        <button class="auth-tab-btn active" data-auth-tab="login">Login</button>
        <button class="auth-tab-btn" data-auth-tab="register">Sign Up</button>
      </div>

      <!-- Login Form -->
      <div id="loginForm" class="auth-form-content">
        <div id="authMessage" class="message"></div>
        <form id="loginFormEl">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="loginUsername" required>
            <span class="error-text" id="loginUsernameError"></span>
          </div>
          <div class="form-group">
            <label class="form-label">Password</label>
            <input type="password" class="form-input" id="loginPassword" required>
            <span class="error-text" id="loginPasswordError"></span>
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
          <div style="text-align: right; margin-top: 12px;">
            <button type="button" class="forgot-password-btn" id="forgotPasswordBtn">Forgot password?</button>
          </div>
        </form>
      </div>

      <!-- Sign Up Form -->
      <div id="registerForm" class="auth-form-content hidden">
        <div id="authMessage2" class="message"></div>
        <form id="registerFormEl">
          <div class="form-group">
            <label class="form-label">Username</label>
            <input type="text" class="form-input" id="registerUsername" required>
            <span class="error-text" id="registerUsernameError"></span>
          </div>
          
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="registerEmail" required>
            <span class="error-text" id="registerEmailError"></span>
          </div>
          
          <div class="form-group">
            <label class="form-label">Password</label>
            <input type="password" class="form-input" id="registerPassword" required>
            <span class="error-text" id="registerPasswordError"></span>
          </div>
          
          <div class="form-group">
            <label class="form-label">Confirm Password</label>
            <input type="password" class="form-input" id="registerConfirmPassword" required>
            <span class="error-text" id="registerConfirmPasswordError"></span>
          </div>
          
          <button type="submit" class="btn btn-primary btn-signup" style="width: 100%;">Join Pick'em Competition</button>
        </form>
      </div>
    </div>

    <!-- Main App Section -->
    <div id="appContainer" style="display: none;">
      <div class="page-header">
        <h1 class="page-title">Welcome to <span class="highlight">Pick'em</span></h1>
        <p class="page-subtitle">Make daily NBA predictions and compete with other fans on the leaderboards</p>
      </div>

      <section class="info-section">
        <div class="info-content">
          <h2 style="color: #ef4444;">üìù PLEASE READ</h2>
          <p><strong>Pick'em V1.0</strong> ‚Äî Improved lock system and weekly leaderboards!</p>
          <ul>
            <li>If a <strong>pickem does not show up right away</strong>, click the box for the pickem date and it should load</li>
            <li>When pickems <strong>lock for the day</strong>, the page will automatically prevent submissions - no refresh needed!</li>
            <li>For the leaderboard, your <strong>email will NOT show</strong>, only the <strong>username you choose</strong></li>
            <li><strong>Weekly leaderboards</strong> are now based on the week number assigned to each question</li>
          </ul>
        </div>
      </section>

      <div class="auth-header">
        <div class="user-info">
          <span class="user-welcome">Welcome, <strong id="currentUser"></strong>!</span>
          <span class="user-badge" id="userBadge">Player</span>
        </div>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="picks">Picks</button>
        <button class="tab-btn" data-tab="daily-lb">Daily Leaderboard</button>
        <button class="tab-btn" data-tab="weekly-lb">Weekly Leaderboard</button>
        <button class="tab-btn" data-tab="monthly-lb">Monthly Leaderboard</button>
        <button class="tab-btn" data-tab="winners">Winners</button>
        <button class="tab-btn" data-tab="admin" id="adminTabBtn" style="display: none;">Manage Questions</button>
      </div>

      <!-- Picks Tab -->
      <div id="picks" class="tab-content active">
        <div id="message" class="message"></div>
        
        <input type="hidden" id="selectedPickWeek" />
        
        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 700; color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .06em;">Select Date</label>
          <div class="date-slider-controls">
            <button class="date-nav-btn" id="prevDateBtn">‚Äπ</button>
            <div id="datePickerContainer" class="date-picker-container"></div>
            <button class="date-nav-btn" id="nextDateBtn">‚Ä∫</button>
          </div>
        </div>
        <input type="hidden" id="pickDate" />
        
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>

        <div id="questionsContainer" class="questions-container"></div>
        
        <!-- Lock Time Status Display -->
        <div id="lockTimeStatus" style="display: none; margin-bottom: 1.5rem; padding: 1rem; border-radius: 12px; border-left: 4px solid var(--error); background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));">
          <p style="margin: 0 0 0.5rem 0; font-weight: 700; color: var(--error);">‚è∞ Submissions Closed</p>
          <p id="lockTimeStatusMessage" style="margin: 0; color: var(--ink); font-size: 0.95rem;"></p>
        </div>

        <!-- Countdown Timer Display -->
        <div id="countdownTimer" style="display: none; margin-bottom: 1.5rem; padding: 1rem; border-radius: 12px; border-left: 4px solid var(--brand); background: linear-gradient(135deg, rgba(0, 61, 166, 0.1), rgba(0, 61, 166, 0.05));">
          <p style="margin: 0 0 0.5rem 0; font-weight: 700; color: var(--brand);">‚è±Ô∏è Time Until Submissions Close</p>
          <p id="countdownText" style="margin: 0; color: var(--ink); font-size: 1.1rem; font-weight: 700;"></p>
        </div>
        
        <div class="submit-section">
          <button type="button" class="btn btn-primary" id="submitBtn">Submit Picks</button>
          <button type="button" class="btn btn-secondary" id="clearBtn">Clear All</button>
        </div>
      </div>

      <!-- Daily Leaderboard Tab -->
      <div id="daily-lb" class="tab-content">
        <div class="date-slider-controls" style="margin-bottom: 15px;">
          <button class="date-nav-btn" id="prevDailyDateBtn">‚Äπ</button>
          <div id="dailyDatePickerContainer" class="date-picker-container"></div>
          <button class="date-nav-btn" id="nextDailyDateBtn">‚Ä∫</button>
        </div>
        <input type="hidden" id="dailyLbDate" />
        <div style="margin-bottom: 15px;">
          <button type="button" class="btn btn-secondary" id="refreshDailyBtn">üîÑ Refresh</button>
        </div>
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Player</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody id="dailyLeaderboardBody"></tbody>
        </table>
      </div>

      <!-- Weekly Leaderboard Tab -->
      <div id="weekly-lb" class="tab-content">
        <div class="date-slider-controls" style="margin-bottom: 15px;">
          <button class="date-nav-btn" id="prevWeekBtn">‚Äπ</button>
          <div id="weekPickerContainer" class="date-picker-container"></div>
          <button class="date-nav-btn" id="nextWeekBtn">‚Ä∫</button>
        </div>
        <div style="margin-bottom: 15px;">
          <button type="button" class="btn btn-secondary" id="refreshWeeklyBtn">üîÑ Refresh</button>
        </div>
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Player</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody id="weeklyLeaderboardBody"></tbody>
        </table>
      </div>

      <!-- Monthly Leaderboard Tab -->
      <div id="monthly-lb" class="tab-content">
        <div class="date-slider-controls" style="margin-bottom: 15px;">
          <button class="date-nav-btn" id="prevMonthBtn">‚Äπ</button>
          <div id="monthPickerContainer" class="date-picker-container"></div>
          <button class="date-nav-btn" id="nextMonthBtn">‚Ä∫</button>
        </div>
        <div style="margin-bottom: 15px;">
          <button type="button" class="btn btn-secondary" id="refreshMonthlyBtn">üîÑ Refresh</button>
        </div>
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Player</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody id="monthlyLeaderboardBody"></tbody>
        </table>
      </div>

      <!-- Winners Tab -->
      <div id="winners" class="tab-content">
        <div style="margin-bottom: 2rem;">
          <h2 style="color: var(--brand); margin-bottom: 1.5rem;">üèÜ Weekly Winners</h2>
          
          <div style="background: var(--white); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
            <table class="leaderboard-table" style="margin-bottom: 0;">
              <thead>
                <tr>
                  <th>Week</th>
                  <th>Winner</th>
                  <th>Score</th>
                </tr>
              </thead>
              <tbody id="publicWinnersTableBody">
                <tr>
                  <td colspan="3" style="text-align: center; padding: 3rem 2rem; color: var(--muted);">No winners yet</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Admin Panel Tab -->
      <div id="admin" class="tab-content">
        <div class="admin-panel">
          <h2>Manage Today's Questions</h2>
          <div id="adminMessage" class="message"></div>

          <div class="admin-date-section">
            <label>Date:</label>
            <input type="date" id="adminDate" />
            <button class="btn btn-secondary" id="loadDateBtn">Load Questions</button>
          </div>

          <div style="margin-bottom: 2rem;">
            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
              <button class="btn btn-secondary" id="addQuestionTabBtn" style="flex: 1; background: #e0e7ff; color: var(--brand); border: 2px solid var(--brand);">‚ûï Add Questions</button>
              <button class="btn btn-secondary" id="markAnswersTabBtn" style="flex: 1;">‚úÖ Mark Correct Answers</button>
            </div>

            <!-- Add Questions Tab -->
            <div id="addQuestionTab" style="display: block;">
              <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; color: #92400e;">
                <p style="margin: 0; font-weight: 600; font-size: 0.9rem;">üí° Tip: Set the <strong>Week Number</strong> field to assign questions to a specific week for the weekly leaderboard. This is the ONLY field needed for weekly leaderboards to work! Day of Week is optional and for your reference only.</p>
              </div>
              <div class="admin-form">
                <h3 style="margin-top: 0;">Add New Question</h3>
                
                <div class="form-group">
                  <label class="form-label">Question Text</label>
                  <input type="text" id="adminQuestionText" class="form-input" placeholder="e.g., Will the 76ers win today?" />
                </div>

                <div class="form-group">
                  <label class="form-label">Question Type</label>
                  <select id="adminQuestionType" class="form-input">
                    <option value="yes_no">Yes/No</option>
                    <option value="multiple_choice">Multiple Choice</option>
                    <option value="numeric">Numeric</option>
                  </select>
                </div>

                <div class="form-group" id="optionsGroup" style="display: none;">
                  <label class="form-label">Options (comma separated)</label>
                  <input type="text" id="adminOptions" class="form-input" placeholder="e.g., Option 1, Option 2, Option 3" />
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                  <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Week Number (Optional)</label>
                    <input type="number" id="adminQuestionWeek" class="form-input" placeholder="e.g., 1" min="1" />
                  </div>
                  <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">Day of Week (Optional)</label>
                    <select id="adminQuestionDay" class="form-input">
                      <option value="">-- Select Day --</option>
                      <option value="MON">Monday</option>
                      <option value="TUE">Tuesday</option>
                      <option value="WED">Wednesday</option>
                      <option value="THU">Thursday</option>
                      <option value="FRI">Friday</option>
                      <option value="SAT">Saturday</option>
                      <option value="SUN">Sunday</option>
                    </select>
                  </div>
                </div>

                <button class="btn btn-primary" id="addQuestionBtn">Add Question</button>
              </div>

              <div class="admin-questions-list">
                <h3>Today's Questions</h3>
                <div id="adminQuestionsList"></div>
                <button class="btn btn-primary" id="saveQuestionsBtn" style="margin-top: 1rem;">Save All to Database</button>
              </div>
            </div>

            <!-- Mark Answers Tab -->
            <div id="markAnswersTab" style="display: none;">
              <div class="admin-form">
                <h3 style="margin-top: 0;">Mark Correct Answers</h3>
                <div id="markAnswersMessage" class="message"></div>

                <div class="admin-date-section" style="background: var(--chip); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem;">
                  <label style="margin: 0; font-weight: 700; color: var(--ink);">Select Date:</label>
                  <input type="date" id="markAnswersDate" />
                  <button class="btn btn-secondary" id="loadQuestionsForAnswersBtn">Load Questions</button>
                </div>

                <div class="answers-list" id="answersList" style="margin-top: 1.5rem;">
                  <!-- Questions will be loaded here with answer input fields -->
                </div>

                <button class="btn btn-primary" id="saveCorrectAnswersBtn" style="display: none; margin-top: 1rem;">Save Correct Answers</button>
              </div>
            </div>
          </div>



          <!-- Weekly Leaderboard Info -->
          <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border);">
          <div class="weekly-info-section">
            <h2>üìÖ Weekly Leaderboard System</h2>
            <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--success);">
              <p style="margin: 0 0 1rem 0; font-weight: 700; color: var(--ink);">‚úÖ Simplified Weekly Leaderboards</p>
              <p style="margin: 0; color: var(--muted); line-height: 1.6;">
                The weekly leaderboard now works automatically based on the <strong>Week Number</strong> field you assign to each question. 
                Simply set the Week Number when adding questions (e.g., Week 1, Week 2, etc.), and the weekly leaderboard will automatically 
                calculate scores for all questions with that week number across all dates. No need to manage week date ranges!
              </p>
            </div>
          </div>

          <!-- Set Submission Lock Time Section -->
          <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border);">
          <div class="lock-time-section">
            <h2>‚è∞ Set Submission Lock Time</h2>
            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Set the time when submissions lock for this date (EST timezone)</p>
            <div id="lockTimeMessage" class="message"></div>

            <div style="background: var(--chip); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
              <div class="form-group" style="margin-bottom: 1rem;">
                <label class="form-label">Select Date: <span id="selectedLockDate" style="color: var(--brand); font-weight: 700; font-size: 0.9rem;"></span></label>
                <input type="date" id="lockTimeDate" style="border: 2px solid var(--border);" />
                <small style="color: var(--muted); display: block; margin-top: 0.5rem;">üí° Tip: Click "Load Questions" above first to auto-fill this date</small>
              </div>

              <div class="form-group" style="margin-bottom: 1rem;">
                <label class="form-label">Lock Time (EST):</label>
                <input type="time" id="lockTimeInput" class="form-input" />
                <small style="color: var(--muted); display: block; margin-top: 0.5rem;">Example: 19:00 for 7:00 PM (displays as 7:00 PM)</small>
              </div>

              <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" id="saveLockTimeBtn">üíæ Save Lock Time for Selected Date</button>
                <button class="btn btn-secondary" id="loadLockTimeBtn">Load Current Lock Time</button>
              </div>
            </div>

            <div id="lockTimeDisplay" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); padding: 1rem; border-radius: 12px; border-left: 4px solid var(--success); display: none;">
              <p style="margin: 0; font-weight: 700;">Current Lock Time:</p>
              <p id="lockTimeDisplayValue" style="margin: 0.5rem 0 0 0; font-size: 1.2rem; color: var(--success);"></p>
            </div>
          </div>

          <!-- View & Manage User Submissions Section -->
          <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border);">
          <div class="submissions-section">
            <h2>üìä View & Manage User Submissions</h2>
            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1.5rem;">View user responses and delete submissions for a specific date</p>
            <div id="submissionsMessage" class="message"></div>

            <div class="admin-date-section">
              <label>Select Date:</label>
              <input type="date" id="submissionsDate" />
              <button class="btn btn-secondary" id="loadSubmissionsBtn">Load Submissions</button>
            </div>

            <div style="margin-top: 2rem;">
              <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <button class="btn btn-secondary" id="viewResponsesTabBtn" style="flex: 1; background: #e0e7ff; color: var(--brand); border: 2px solid var(--brand);">üìã View Responses</button>
                <button class="btn btn-secondary" id="deleteSubmissionsTabBtn" style="flex: 1;">üóëÔ∏è Delete Submissions</button>
              </div>

              <!-- Responses View Tab -->
              <div id="responsesViewTab" style="display: block;">
                <div id="responsesContainer" style="display: none;">
                  <!-- User cards will be inserted here -->
                </div>
                <div id="noResponsesMessage" style="text-align: center; padding: 60px 20px; color: var(--muted); background: rgba(0,0,0,0.02); border-radius: 12px; border: 1px solid var(--border);">
                  <p style="font-size: 36px; margin-bottom: 10px;">üìã</p>
                  <p style="font-weight: 600; font-size: 1rem;">No responses found for this date</p>
                </div>
              </div>

              <!-- Delete Submissions View Tab -->
              <div id="deleteViewTab" style="display: none;">
                <div style="overflow-x: auto;">
                  <table id="deleteSubmissionsTable" style="width: 100%; border-collapse: collapse; display: none;">
                    <thead>
                      <tr style="background: #f8fafc; border-bottom: 2px solid var(--border);">
                        <th style="padding: 14px; text-align: left; font-weight: 900; color: var(--brand);">User Email</th>
                        <th style="padding: 14px; text-align: center; font-weight: 900; color: var(--brand);">Answers Submitted</th>
                        <th style="padding: 14px; text-align: center; font-weight: 900; color: var(--brand);">Action</th>
                      </tr>
                    </thead>
                    <tbody id="deleteSubmissionsTableBody">
                    </tbody>
                  </table>
                  <div id="noSubmissionsForDeleteMessage" style="text-align: center; padding: 60px 20px; color: var(--muted); background: rgba(0,0,0,0.02); border-radius: 12px; border: 1px solid var(--border);">
                    <p style="font-size: 36px; margin-bottom: 10px;">üì≠</p>
                    <p style="font-weight: 600; font-size: 1rem;">No submissions found for this date</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Leaderboard Override Section -->
          <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border);">
          <div class="leaderboard-override-section">
            <h2>üîß Leaderboard Override</h2>
            <p style="color: var(--muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Manually adjust user scores if something goes wrong</p>
            <div id="overrideMessage" class="message"></div>

            <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; color: #92400e;">
              <p style="margin: 0; font-weight: 600; font-size: 0.9rem;">‚ö†Ô∏è Warning: This will override the calculated score for a specific user and date. Use only when necessary!</p>
            </div>

            <div class="admin-form">
              <div class="form-group">
                <label class="form-label">User Email</label>
                <input type="email" id="overrideUserEmail" class="form-input" placeholder="user@example.com" />
              </div>

              <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" id="overrideDate" class="form-input" />
              </div>

              <div class="form-group">
                <label class="form-label">New Score</label>
                <input type="number" id="overrideScore" class="form-input" placeholder="Enter score" min="0" />
              </div>

              <button class="btn btn-primary" id="applyOverrideBtn" style="width: 100%;">Apply Score Override</button>
            </div>

            <div style="margin-top: 2rem;">
              <h3>Current Overrides</h3>
              <div id="overridesList" style="margin-top: 1rem;">
                <div style="text-align: center; padding: 40px 20px; color: var(--muted); background: rgba(0,0,0,0.02); border-radius: 12px; border: 1px solid var(--border);">
                  <p style="font-size: 24px; margin-bottom: 10px;">üìù</p>
                  <p style="font-weight: 600; font-size: 0.9rem;">No overrides set</p>
                </div>
              </div>
            </div>
          </div>

          <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border);">

          <h3 style="margin-top: 2rem;">Manage Weekly Winners</h3>
          <p style="color: #64748b; margin-bottom: 1.5rem;">Add and manage weekly winners for the competition.</p>

          <div class="admin-form">
            <div class="form-group">
              <label class="form-label">Week Number</label>
              <input type="text" id="adminWinnersWeek" class="form-input" placeholder="e.g., 1 or Week 1" />
            </div>

            <div class="form-group">
              <label class="form-label">Winner Username</label>
              <input type="text" id="adminWinnersUsername" class="form-input" placeholder="Enter the winning player's username" />
            </div>

            <div class="form-group">
              <label class="form-label">Score</label>
              <input type="number" id="adminWinnersScore" class="form-input" placeholder="Enter the winning score" min="0" />
            </div>

            <button class="btn btn-primary" id="adminAddWinnerBtn" style="width: 100%;">Add Winner</button>
          </div>

          <div class="admin-questions-list">
            <h3 style="margin-top: 0;">Weekly Winners</h3>
            <div id="adminWinnersMessage" class="message"></div>
            <div style="overflow-x: auto;">
              <table id="adminWinnersTable" style="width: 100%; border-collapse: collapse; display: none;">
                <thead>
                  <tr style="background: #f8fafc; border-bottom: 2px solid var(--border);">
                    <th style="padding: 14px; text-align: left; font-weight: 900; color: var(--brand);">Week</th>
                    <th style="padding: 14px; text-align: left; font-weight: 900; color: var(--brand);">Winner</th>
                    <th style="padding: 14px; text-align: center; font-weight: 900; color: var(--brand);">Score</th>
                    <th style="padding: 14px; text-align: center; font-weight: 900; color: var(--brand);">Action</th>
                  </tr>
                </thead>
                <tbody id="adminWinnersTableBody">
                </tbody>
              </table>
              <div id="noWinnersMessage" style="text-align: center; padding: 60px 20px; color: var(--muted); background: rgba(0,0,0,0.02); border-radius: 12px; border: 1px solid var(--border);">
                <p style="font-size: 36px; margin-bottom: 10px;">üèÜ</p>
                <p style="font-weight: 600; font-size: 1rem;">No winners added yet</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="nav.js"></script>
  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBzMlBV5gbZZlg_eTwNWrRDrhx-_ATIPS0",
      authDomain: "pickem-1e12b.firebaseapp.com",
      projectId: "pickem-1e12b",
      storageBucket: "pickem-1e12b.firebasestorage.app",
      messagingSenderId: "715626120695",
      appId: "1:715626120695:web:4942646cf3d6ca7e181af2",
      measurementId: "G-B22K71F01E"
    };

    // Wait for Firebase SDK to load before initializing
    let auth, db;
    let firebaseReady = false;
    
    function initializeFirebase() {
      if (typeof firebase === 'undefined') {
        setTimeout(initializeFirebase, 100);
        return;
      }
      firebase.initializeApp(firebaseConfig);
      auth = firebase.auth();
      db = firebase.firestore();
      firebaseReady = true;
      initAuth();
    }
    
    // Start Firebase initialization
    initializeFirebase();

    let currentUser = null;
    let currentUserEmail = null;
    let todayQuestions = [];
    let adminQuestions = [];
    let selectedPickDate = null;
    let isCurrentUserAdmin = false;

    // === Authentication ===
    function initAuth() {
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user.displayName || user.email.split('@')[0];
          currentUserEmail = user.email;
          localStorage.setItem('pickem_user', currentUser);
          showApp();
        } else {
          currentUser = null;
          currentUserEmail = null;
          localStorage.removeItem('pickem_user');
          showAuth();
        }
      });
    }

    function showAuth() {
      document.getElementById('authContainer').style.display = 'block';
      document.getElementById('appContainer').style.display = 'none';
    }

    function showApp() {
      document.getElementById('authContainer').style.display = 'none';
      document.getElementById('appContainer').style.display = 'block';
      document.getElementById('currentUser').textContent = currentUser;
      
      const isAdmin = isUserAdmin();
      isCurrentUserAdmin = isAdmin;
      if (isAdmin) {
        document.getElementById('userBadge').textContent = 'Admin';
        document.getElementById('userBadge').style.background = '#fef3c7';
        document.getElementById('userBadge').style.color = '#92400e';
        document.getElementById('adminTabBtn').style.display = 'block';
        loadWinners();
        loadOverrides();
      } else {
        document.getElementById('adminTabBtn').style.display = 'none';
      }
      document.getElementById('pickWeekSection').style.display = 'block';
      
      const currentDate = formatDateForComparison(new Date());
      console.log(`üîÑ User authenticated. Reloading questions for ${currentDate} to check submissions`);
      selectedPickDate = currentDate;
      document.getElementById('pickDate').value = currentDate;
      renderDateSlider();
      loadQuestionsForDate(currentDate);
      
      loadPublicWinners();
      
      loadWeeks().then(() => {
        console.log('‚è∞ Weeks loaded, initializing leaderboard pickers');
        initializeLeaderboardPickers();
      });
    }

    function isUserAdmin() {
      return currentUserEmail === 'rhatus13@gmail.com';
    }

    function checkAdminPermission() {
      if (!isCurrentUserAdmin) {
        showMessage('‚õî Unauthorized: Admin access required', 'error', 'adminMessage');
        return false;
      }
      return true;
    }

    // Clear all error messages
    function clearErrors() {
      document.querySelectorAll('.error-text').forEach(el => el.textContent = '');
    }

    // Clear form input values
    function clearLoginForm() {
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginPassword').value = '';
      clearErrors();
    }

    function clearRegisterForm() {
      document.getElementById('registerUsername').value = '';
      document.getElementById('registerEmail').value = '';
      document.getElementById('registerPassword').value = '';
      document.getElementById('registerConfirmPassword').value = '';
      clearErrors();
    }

    // Auth Tab Switching
    document.querySelectorAll('.auth-tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const tab = btn.dataset.authTab;
        document.querySelectorAll('.auth-tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.auth-form-content').forEach(f => f.classList.add('hidden'));
        document.querySelectorAll('.message').forEach(m => m.classList.remove('show'));
        btn.classList.add('active');
        document.getElementById(tab + 'Form').classList.remove('hidden');
        clearErrors();
      });
    });

    // Login Form Validation
    function validateLoginForm(username, password) {
      const errors = {};
      if (!username.trim()) {
        errors.username = 'Username or email is required';
      }
      if (!password) {
        errors.password = 'Password is required';
      }
      return errors;
    }

    // Register Form Validation
    function validateRegisterForm(formData) {
      const errors = {};
      const { username, email, password, confirmPassword } = formData;

      // Username validation
      if (!username.trim()) {
        errors.username = 'Username is required';
      } else if (username.length < 3) {
        errors.username = 'Username must be at least 3 characters';
      }

      // Email validation
      if (!email.trim()) {
        errors.email = 'Email is required';
      } else if (!/\S+@\S+\.\S+/.test(email)) {
        errors.email = 'Email is invalid';
      }

      // Password validation
      if (!password) {
        errors.password = 'Password is required';
      } else if (password.length < 6) {
        errors.password = 'Password must be at least 6 characters';
      }

      // Confirm password validation
      if (password !== confirmPassword) {
        errors.confirmPassword = 'Passwords do not match';
      }

      return errors;
    }

    // Display form errors
    function displayErrors(errors, formType) {
      clearErrors();
      if (formType === 'login') {
        if (errors.username) {
          document.getElementById('loginUsernameError').textContent = errors.username;
        }
        if (errors.password) {
          document.getElementById('loginPasswordError').textContent = errors.password;
        }
      } else if (formType === 'register') {
        if (errors.username) {
          document.getElementById('registerUsernameError').textContent = errors.username;
        }
        if (errors.email) {
          document.getElementById('registerEmailError').textContent = errors.email;
        }
        if (errors.password) {
          document.getElementById('registerPasswordError').textContent = errors.password;
        }
        if (errors.confirmPassword) {
          document.getElementById('registerConfirmPasswordError').textContent = errors.confirmPassword;
        }
      }
    }

    // Login Form
    document.getElementById('loginFormEl').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;

      // Validate
      const errors = validateLoginForm(email, password);
      if (Object.keys(errors).length > 0) {
        displayErrors(errors, 'login');
        return;
      }

      try {
        await auth.signInWithEmailAndPassword(email, password);
        showMessage('Login successful!', 'success', 'authMessage');
        setTimeout(() => {
          document.getElementById('loginFormEl').reset();
          showApp();
        }, 500);
      } catch (err) {
        showMessage(err.message || 'Login failed', 'error', 'authMessage');
      }
    });

    // Register Form
    document.getElementById('registerFormEl').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('registerUsername').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('registerConfirmPassword').value;

      // Validate
      const errors = validateRegisterForm({ username, email, password, confirmPassword });
      if (Object.keys(errors).length > 0) {
        displayErrors(errors, 'register');
        return;
      }

      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await userCredential.user.updateProfile({ displayName: username });
        
        // Save user profile to Firestore
        await db.collection('users').doc(userCredential.user.uid).set({
          username: username,
          email: email,
          createdAt: new Date().toISOString()
        });

        showMessage('‚úÖ Account created! Please log in with your new credentials.', 'success', 'authMessage2');
        setTimeout(() => {
          clearRegisterForm();
          document.querySelectorAll('.auth-tab-btn')[0].click();
          document.getElementById('loginUsername').value = email;
          document.getElementById('loginPassword').focus();
          auth.signOut();
        }, 500);
      } catch (err) {
        showMessage(err.message || 'Registration failed', 'error', 'authMessage2');
      }
    });

    // Forgot Password Button
    document.getElementById('forgotPasswordBtn').addEventListener('click', (e) => {
      e.preventDefault();
      showMessage('Password reset functionality coming soon!', 'error', 'authMessage');
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await auth.signOut();
        document.getElementById('loginFormEl').reset();
        document.getElementById('registerFormEl').reset();
        showAuth();
      } catch (err) {
        showMessage('Error logging out', 'error');
      }
    });

    // === Admin Panel ===
    // Set today's date by default using timezone-safe formatting
    const today = new Date();
    const adminDateInput = document.getElementById('adminDate');
    const lockTimeDateInput = document.getElementById('lockTimeDate');
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const todayDateStr = `${year}-${month}-${day}`;
    adminDateInput.value = todayDateStr;
    lockTimeDateInput.value = todayDateStr;
    console.log(`üìÖ Admin date initialized to: ${adminDateInput.value}`);

    // Toggle options field based on question type
    document.getElementById('adminQuestionType').addEventListener('change', (e) => {
      const optionsGroup = document.getElementById('optionsGroup');
      if (e.target.value === 'multiple_choice') {
        optionsGroup.style.display = 'block';
      } else {
        optionsGroup.style.display = 'none';
      }
    });

    // Tab switching for add questions and mark answers
    document.getElementById('addQuestionTabBtn').addEventListener('click', () => {
      document.getElementById('addQuestionTab').style.display = 'block';
      document.getElementById('markAnswersTab').style.display = 'none';
      
      document.getElementById('addQuestionTabBtn').style.background = '#e0e7ff';
      document.getElementById('addQuestionTabBtn').style.color = 'var(--brand)';
      document.getElementById('addQuestionTabBtn').style.border = '2px solid var(--brand)';
      
      document.getElementById('markAnswersTabBtn').style.background = 'transparent';
      document.getElementById('markAnswersTabBtn').style.color = 'var(--muted)';
      document.getElementById('markAnswersTabBtn').style.border = 'none';
    });

    document.getElementById('markAnswersTabBtn').addEventListener('click', () => {
      document.getElementById('addQuestionTab').style.display = 'none';
      document.getElementById('markAnswersTab').style.display = 'block';
      
      document.getElementById('markAnswersTabBtn').style.background = '#e0e7ff';
      document.getElementById('markAnswersTabBtn').style.color = 'var(--brand)';
      document.getElementById('markAnswersTabBtn').style.border = '2px solid var(--brand)';
      
      document.getElementById('addQuestionTabBtn').style.background = 'transparent';
      document.getElementById('addQuestionTabBtn').style.color = 'var(--muted)';
      document.getElementById('addQuestionTabBtn').style.border = 'none';
    });

    // Add question to admin list
    document.getElementById('addQuestionBtn').addEventListener('click', () => {
      if (!checkAdminPermission()) return;
      
      const text = document.getElementById('adminQuestionText').value.trim();
      const type = document.getElementById('adminQuestionType').value;
      const options = document.getElementById('adminOptions').value.trim();
      const weekNumber = document.getElementById('adminQuestionWeek').value.trim();
      const dayOfWeek = document.getElementById('adminQuestionDay').value.trim();

      if (!text) {
        showMessage('Please enter a question', 'error', 'adminMessage');
        return;
      }

      if (type === 'multiple_choice' && !options) {
        showMessage('Please enter options for multiple choice question', 'error', 'adminMessage');
        return;
      }

      const newQuestion = {
        question: text,
        question_type: type,
        options: type === 'multiple_choice' ? options : null,
        weekNumber: weekNumber ? parseInt(weekNumber) : null,
        dayOfWeek: dayOfWeek || null,
        tempId: Date.now()
      };

      adminQuestions.push(newQuestion);
      renderAdminQuestions();
      
      // Clear form
      document.getElementById('adminQuestionText').value = '';
      document.getElementById('adminOptions').value = '';
      document.getElementById('adminQuestionType').value = 'yes_no';
      document.getElementById('adminQuestionWeek').value = '';
      document.getElementById('adminQuestionDay').value = '';
      document.getElementById('optionsGroup').style.display = 'none';
      
      showMessage('Question added! Click "Save All to Database" when done.', 'success', 'adminMessage');
    });

    // Delete question from admin list
    function deleteAdminQuestion(tempId) {
      adminQuestions = adminQuestions.filter(q => q.tempId !== tempId);
      renderAdminQuestions();
    }

    // Render admin questions list
    function renderAdminQuestions() {
      const container = document.getElementById('adminQuestionsList');
      
      if (adminQuestions.length === 0) {
        container.innerHTML = '<p style="color: var(--muted); text-align: center;">No questions added yet.</p>';
        return;
      }

      container.innerHTML = adminQuestions.map((q, index) => `
        <div class="admin-question-item">
          <div class="admin-question-item-content">
            <div class="admin-question-item-text">${index + 1}. ${q.question}</div>
            <div class="admin-question-item-type">${q.question_type === 'yes_no' ? 'Yes/No' : q.question_type === 'multiple_choice' ? 'Multiple Choice' : 'Numeric'}</div>
            ${q.options ? `<div class="admin-question-item-options">Options: ${q.options}</div>` : ''}
            ${q.weekNumber || q.dayOfWeek ? `<div class="admin-question-item-options" style="color: #3b82f6; margin-top: 0.5rem; font-weight: 600;">üìÖ Week: ${q.weekNumber || '-'} | Day: ${q.dayOfWeek || '-'}</div>` : ''}
          </div>
          <div class="admin-question-item-actions">
            <button class="admin-delete-btn" onclick="deleteAdminQuestion(${q.tempId})">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Load questions for a specific date
    document.getElementById('loadDateBtn').addEventListener('click', async () => {
      if (!checkAdminPermission()) return;
      
      const dateInput = document.getElementById('adminDate').value;
      if (!dateInput) {
        showMessage('Please select a date', 'error', 'adminMessage');
        return;
      }

      try {
        const snapshot = await db.collection('questions').where('date', '==', dateInput).get();
        
        if (snapshot.empty) {
          adminQuestions = [];
          showMessage('No questions found for this date', 'info', 'adminMessage');
        } else {
          const doc = snapshot.docs[0];
          const data = doc.data();
          adminQuestions = (data.items || []).map(q => ({
            ...q,
            tempId: Date.now() + Math.random(),
            weekNumber: q.weekNumber || null,
            dayOfWeek: q.dayOfWeek || null
          }));
          showMessage('Questions loaded successfully', 'success', 'adminMessage');
        }
        renderAdminQuestions();
      } catch (err) {
        console.error('Error loading questions:', err);
        showMessage('Error loading questions', 'error', 'adminMessage');
      }
    });

    // Save all questions to database
    document.getElementById('saveQuestionsBtn').addEventListener('click', async () => {
      if (!checkAdminPermission()) return;
      


      const dateInput = document.getElementById('adminDate').value;
      if (!dateInput) {
        showMessage('Please select a date', 'error', 'adminMessage');
        return;
      }

      try {
        // Validate date format is correct (should be YYYY-MM-DD)
        if (!/^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
          console.warn(`‚ö†Ô∏è Invalid date format: "${dateInput}" - expected YYYY-MM-DD`);
          showMessage('Invalid date format. Please use date picker.', 'error', 'adminMessage');
          return;
        }
        
        console.log(`üíæ Admin saving ${adminQuestions.length} questions for date: "${dateInput}" (format verified: YYYY-MM-DD)`);
        console.log(`   Date from input element: "${dateInput}" (selected: ${document.getElementById('adminDate').value})`);
        console.log(`   Current local time: ${new Date().toString()}`);
        
        // Remove tempId from questions before saving
        const questionsToSave = adminQuestions.map(q => {
          const { tempId, ...rest } = q;
          return rest;
        });
        
        console.log('üìù Questions to save:', questionsToSave);

        // Check if document exists for this date
        const snapshot = await db.collection('questions').where('date', '==', dateInput).get();
        
        if (!snapshot.empty) {
          console.log(`üì§ Updating existing questions document for ${dateInput}`);
          console.log(`   Existing doc ID: ${snapshot.docs[0].id}`);
          // Update existing document
          await snapshot.docs[0].ref.update({
            items: questionsToSave,
            updatedAt: new Date().toISOString()
          });
        } else {
          console.log(`üÜï Creating new questions document for ${dateInput}`);
          const docRef = await db.collection('questions').add({
            date: dateInput,
            items: questionsToSave,
            createdAt: new Date().toISOString()
          });
          console.log(`   New doc ID: ${docRef.id}`);
        }

        console.log(`‚úÖ Questions saved successfully for ${dateInput}!`);
        showMessage('‚úÖ Questions saved successfully! Now go to Mark Correct Answers to set answers and weeks.', 'success', 'adminMessage');
        adminQuestions = [];
        renderAdminQuestions();
      } catch (err) {
        console.error('Error saving questions:', err);
        console.error('Error details:', err.message);
        showMessage('Error saving questions: ' + err.message, 'error', 'adminMessage');
      }
    });

    // === Mark Correct Answers ===
    let questionsForAnswers = [];

    document.getElementById('loadQuestionsForAnswersBtn').addEventListener('click', async () => {
      if (!checkAdminPermission()) return;
      
      const dateInput = document.getElementById('markAnswersDate').value;
      if (!dateInput) {
        showMessage('Please select a date', 'error', 'markAnswersMessage');
        return;
      }

      try {
        const snapshot = await db.collection('questions').where('date', '==', dateInput).get();
        
        if (snapshot.empty) {
          showMessage('No questions found for this date', 'info', 'markAnswersMessage');
          questionsForAnswers = [];
          document.getElementById('answersList').innerHTML = '';
          document.getElementById('saveCorrectAnswersBtn').style.display = 'none';
          return;
        }

        const doc = snapshot.docs[0];
        const data = doc.data();
        questionsForAnswers = (data.items || []).map((q, idx) => ({
          ...q,
          questionId: idx,
          docId: doc.id,
          weekNumber: q.weekNumber || null,
          dayOfWeek: q.dayOfWeek || null
        }));

        renderAnswersForm();
        document.getElementById('saveCorrectAnswersBtn').style.display = 'block';
        showMessage('Questions loaded successfully', 'success', 'markAnswersMessage');
      } catch (err) {
        console.error('Error loading questions:', err);
        showMessage('Error loading questions', 'error', 'markAnswersMessage');
      }
    });

    function renderAnswersForm() {
      const container = document.getElementById('answersList');
      
      if (questionsForAnswers.length === 0) {
        container.innerHTML = '<p style="color: var(--muted); text-align: center;">No questions to mark.</p>';
        return;
      }

      container.innerHTML = questionsForAnswers.map((q, idx) => {
        let answerInput = '';
        const inputId = `answer_${idx}`;
        
        if (q.question_type === 'yes_no') {
          answerInput = `
            <div style="margin-top: 0.75rem; display: flex; gap: 2rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="radio" name="${inputId}" value="Yes" class="answer-input-${idx}" /> 
                <span style="font-weight: 500;">Yes</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="radio" name="${inputId}" value="No" class="answer-input-${idx}" /> 
                <span style="font-weight: 500;">No</span>
              </label>
            </div>
          `;
        } else if (q.question_type === 'multiple_choice') {
          const options = q.options.split(',').map(opt => opt.trim());
          answerInput = `
            <div style="margin-top: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem;">
              ${options.map((opt, optIdx) => `
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.4rem 0.6rem; border-radius: 6px; transition: background 0.2s;">
                  <input type="radio" name="${inputId}" value="${opt}" class="answer-input-${idx}" /> 
                  <span>${opt}</span>
                </label>
              `).join('')}
            </div>
          `;
        } else if (q.question_type === 'numeric') {
          answerInput = `
            <input type="number" name="${inputId}" class="form-input answer-input-${idx}" placeholder="Enter the correct number" style="margin-top: 0.75rem; max-width: 250px; padding: 0.6rem; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem;" />
          `;
        }

        return `
          <div class="answer-card-${idx}" style="border: 2px solid var(--border); padding: 1.25rem; margin-bottom: 1rem; border-radius: 12px; background: var(--white); transition: all 0.3s; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
              <div>
                <div style="font-weight: 700; font-size: 1rem; margin-bottom: 0.25rem;">${idx + 1}. ${q.question}</div>
                <div style="color: var(--muted); font-size: 0.85rem;">${q.question_type === 'yes_no' ? 'Yes/No' : q.question_type === 'multiple_choice' ? 'Multiple Choice' : 'Numeric'}</div>
                ${q.weekNumber || q.dayOfWeek ? `<div style="color: #3b82f6; font-size: 0.85rem; font-weight: 600; margin-top: 0.25rem;">üìÖ Week: ${q.weekNumber || '-'} | Day: ${q.dayOfWeek || '-'}</div>` : ''}
              </div>
              <span class="answer-indicator-${idx}" style="display: inline-block; width: 24px; height: 24px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">‚è≥</span>
            </div>
            ${q.options ? `<div style="color: var(--muted); font-size: 0.85rem; margin-bottom: 0.75rem;">Options: ${q.options}</div>` : ''}
            <div style="margin-top: 0.75rem; font-weight: 600; color: var(--ink);">Correct Answer:</div>
            ${answerInput}
          </div>
        `;
      }).join('');

      questionsForAnswers.forEach((q, idx) => {
        const inputs = document.querySelectorAll(`.answer-input-${idx}`);
        inputs.forEach(input => {
          input.addEventListener('change', () => {
            updateAnswerIndicator(idx);
          });
        });

        // Pre-populate with existing correct answer if available
        if (q.correctAnswer !== undefined && q.correctAnswer !== null) {
          if (q.question_type === 'yes_no' || q.question_type === 'multiple_choice') {
            const radio = document.querySelector(`input[name="answer_${idx}"][value="${q.correctAnswer}"]`);
            if (radio) {
              radio.checked = true;
              updateAnswerIndicator(idx);
            }
          } else if (q.question_type === 'numeric') {
            const numInput = document.querySelector(`input[name="answer_${idx}"]`);
            if (numInput) {
              numInput.value = q.correctAnswer;
              updateAnswerIndicator(idx);
            }
          }
        }
      });
      
      setupAnswerAutoSaveIndicator();
    }

    function updateAnswerIndicator(idx) {
      const inputs = document.querySelectorAll(`.answer-input-${idx}`);
      let isAnswered = false;
      
      for (let input of inputs) {
        if (input.type === 'radio' && input.checked) {
          isAnswered = true;
          break;
        } else if (input.type === 'number' && input.value) {
          isAnswered = true;
          break;
        }
      }

      const indicator = document.querySelector(`.answer-indicator-${idx}`);
      const card = document.querySelector(`.answer-card-${idx}`);
      
      if (isAnswered) {
        indicator.innerHTML = '‚úÖ';
        indicator.style.background = '#d1fae5';
        indicator.style.color = '#065f46';
        card.style.borderColor = '#10b981';
        card.style.background = '#f0fdf4';
      } else {
        indicator.innerHTML = '‚è≥';
        indicator.style.background = '#e5e7eb';
        indicator.style.color = '#666';
        card.style.borderColor = 'var(--border)';
        card.style.background = 'var(--white)';
      }
    }

    document.getElementById('saveCorrectAnswersBtn').addEventListener('click', async () => {
      if (!checkAdminPermission()) return;
      
      const dateInput = document.getElementById('markAnswersDate').value;
      
      const correctAnswers = [];
      let allAnswered = true;

      questionsForAnswers.forEach((q, idx) => {
        const inputs = document.querySelectorAll(`input[name="answer_${idx}"]`);
        let answer = null;

        for (let input of inputs) {
          if (input.type === 'radio' && input.checked) {
            answer = input.value;
            break;
          } else if (input.type === 'number' && input.value) {
            answer = parseFloat(input.value);
            break;
          }
        }

        if (answer !== null) {
          correctAnswers.push({
            questionId: idx,
            question: q.question,
            correctAnswer: answer
          });
        }
      });

      if (correctAnswers.length === 0) {
        showMessage('Please enter at least one correct answer before saving', 'error', 'markAnswersMessage');
        return;
      }

      try {
        console.log(`üìù Saving ${correctAnswers.length} answer(s) for date: ${dateInput}`);
        console.log(`üìù Answers being saved:`, correctAnswers);
        
        // Also update questions to ensure week numbers are preserved
        const questionsSnapshot = await db.collection('questions').where('date', '==', dateInput).get();
        if (!questionsSnapshot.empty) {
          const questionDoc = questionsSnapshot.docs[0];
          const updatedItems = questionsForAnswers.map(q => {
            const {questionId, docId, ...rest} = q;
            return rest;
          });
          
          await questionDoc.ref.update({
            items: updatedItems,
            updatedAt: new Date().toISOString()
          });
          console.log('‚úÖ Questions collection updated with week numbers preserved');
        }
        
        const existingAnswers = await db.collection('correctAnswers').where('date', '==', dateInput).get();
        
        let docRef;
        let finalAnswers = correctAnswers;
        
        if (!existingAnswers.empty) {
          console.log(`üìù Found existing answer document for ${dateInput}. Merging answers...`);
          docRef = existingAnswers.docs[0].ref;
          const existingData = existingAnswers.docs[0].data();
          const existingAnswersArray = Array.isArray(existingData.answers) ? existingData.answers : [];
          
          const answerMap = {};
          
          existingAnswersArray.forEach(a => {
            if (a && typeof a === 'object' && a.questionId !== undefined) {
              answerMap[a.questionId] = {
                questionId: a.questionId,
                question: a.question || '',
                correctAnswer: a.correctAnswer
              };
            }
          });
          
          correctAnswers.forEach(a => {
            if (a && typeof a === 'object' && a.questionId !== undefined) {
              answerMap[a.questionId] = {
                questionId: a.questionId,
                question: a.question || '',
                correctAnswer: a.correctAnswer
              };
            }
          });
          
          finalAnswers = Object.keys(answerMap).map(qId => answerMap[qId]);
          
          console.log(`  ‚úÖ Merged ${correctAnswers.length} new answer(s) with ${existingAnswersArray.length} existing, total: ${finalAnswers.length}`);
          console.log(`  üìã Final answers array:`, finalAnswers);
          
          await docRef.update({
            answers: finalAnswers,
            updatedAt: new Date().toISOString()
          });
          console.log('‚úÖ Correct answers UPDATED with ID:', docRef.id);
        } else {
          console.log(`üìù No existing answers found for ${dateInput}. Creating new document...`);
          const cleanAnswers = correctAnswers.map(a => ({
            questionId: a.questionId,
            question: a.question || '',
            correctAnswer: a.correctAnswer
          }));
          
          docRef = await db.collection('correctAnswers').add({
            date: dateInput,
            answers: cleanAnswers,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });
          console.log('‚úÖ Correct answers CREATED with ID:', docRef.id);
          console.log(`  üìã Answers saved:`, cleanAnswers);
        }
        
        showMessage(`‚úÖ ${correctAnswers.length} answer(s) saved! Recalculating leaderboards...`, 'success', 'markAnswersMessage');
        
        console.log('‚è≥ Waiting for Firestore replication with retry...');
        
        let leaderboardsLoaded = false;
        for (let attempt = 1; attempt <= 3; attempt++) {
          const waitTime = attempt === 1 ? 2000 : attempt === 2 ? 3000 : 5000;
          console.log(`  üîÑ Attempt ${attempt}/3: Waiting ${waitTime}ms before loading leaderboards...`);
          await new Promise(resolve => setTimeout(resolve, waitTime));
          
          const verifySnapshot = await db.collection('correctAnswers').where('date', '==', dateInput).get();
          console.log(`  ‚úì Verification: Found ${verifySnapshot.size} answer document(s) for ${dateInput}`);
          
          if (verifySnapshot.empty) {
            console.warn(`  ‚ö†Ô∏è Answers not yet replicated. Retrying...`);
            continue;
          }
          
          console.log(`üîÑ Recalculating leaderboard for date: ${dateInput}`);
          try {
            await loadLeaderboard('daily', null, null, dateInput);
            console.log('‚úÖ Leaderboards recalculated successfully');
            leaderboardsLoaded = true;
            break;
          } catch (leaderboardErr) {
            console.error(`‚ùå Error recalculating leaderboards on attempt ${attempt}:`, leaderboardErr);
            if (attempt < 3) {
              console.log('  ‚è≥ Will retry...');
              continue;
            }
            showMessage('‚ö†Ô∏è Answers saved but leaderboard update failed. Check console for details.', 'error', 'markAnswersMessage');
            return;
          }
        }
        
        if (leaderboardsLoaded) {
          showMessage('‚úÖ Leaderboards updated! Scores have been recalculated.', 'success', 'markAnswersMessage');
        }
      } catch (err) {
        console.error('Error saving correct answers:', err);
        console.error('Error code:', err.code);
        console.error('Error details:', err.message);
        showMessage('‚ùå Error: ' + (err.message || 'Failed to save answers'), 'error', 'markAnswersMessage');
      }
    });

    function setupAnswerAutoSaveIndicator() {
      if (questionsForAnswers.length === 0) return;
      
      questionsForAnswers.forEach((q, idx) => {
        const inputs = document.querySelectorAll(`.answer-input-${idx}`);
        inputs.forEach(input => {
          input.addEventListener('change', () => {
            console.log(`Answer ${idx} changed - Remember to click Save button to persist changes`);
          });
        });
      });
    }

    // === Manage Weeks (DEPRECATED - No longer needed with simplified weekly leaderboard) ===
    let allWeeks = [];

    async function loadWeeks() {
      console.log('‚ö†Ô∏è loadWeeks called but week management is deprecated');
      allWeeks = [];
    }

    function renderWeeks() {
      console.log('‚ö†Ô∏è renderWeeks called but week management is deprecated');
    }

    async function deleteWeek(docId) {
      console.log('‚ö†Ô∏è deleteWeek called but week management is deprecated');
    }

    loadWeeks();

    // === Load Week Data (DEPRECATED - No longer needed) ===
    let selectedWeekData = null;

    // === Lock Time Management ===
    // Update the visual indicator when lock time date changes
    document.getElementById('lockTimeDate').addEventListener('change', function() {
      const date = this.value;
      const indicator = document.getElementById('selectedLockDate');
      if (date) {
        const dateObj = new Date(date + 'T00:00:00');
        const options = { weekday: 'short', month: 'short', day: 'numeric' };
        const formatted = dateObj.toLocaleDateString('en-US', options);
        indicator.textContent = `(${formatted})`;
        this.style.borderColor = 'var(--success)';  // Green border when date is selected
      } else {
        indicator.textContent = '';
        this.style.borderColor = 'var(--border)';
      }
    });

    // Convert 24-hour format (19:00) to 12-hour format (7:00 PM)
    function convert24To12(time24) {
      if (!time24) return null;
      const [hours, minutes] = time24.split(':');
      let hour = parseInt(hours);
      const minute = minutes;
      const ampm = hour >= 12 ? 'PM' : 'AM';
      hour = hour % 12;
      hour = hour ? hour : 12; // 0 should be 12
      return `${hour}:${minute} ${ampm}`;
    }

    // Convert 12-hour format (7:00 PM) to 24-hour format (19:00)
    function convert12To24(time12) {
      if (!time12) return null;
      const parts = time12.trim().split(' ');
      const timePart = parts[0];
      const ampm = parts[1];
      let [hours, minutes] = timePart.split(':');
      let hour = parseInt(hours);
      
      if (ampm === 'PM' && hour !== 12) {
        hour += 12;
      } else if (ampm === 'AM' && hour === 12) {
        hour = 0;
      }
      
      return `${String(hour).padStart(2, '0')}:${minutes}`;
    }

    // Get current time in EST
    function getESTNow() {
      const now = new Date();
      const estTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
      return estTime;
    }

    // Check if submissions are locked for a given date and time
    function areSubmissionsLocked(date, lockTime) {
      if (!lockTime) return false; // No lock time set
      
      const now = getESTNow();
      const today = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      
      // Parse the date to compare
      const [dateYear, dateMonth, dateDay] = date.split('-');
      const dateObj = new Date(parseInt(dateYear), parseInt(dateMonth) - 1, parseInt(dateDay));
      dateObj.setHours(0, 0, 0, 0);
      
      const todayObj = new Date(today);
      todayObj.setHours(0, 0, 0, 0);
      
      // Past dates are always locked
      if (dateObj < todayObj) {
        return true;
      }
      
      // Future dates are never locked
      if (dateObj > todayObj) {
        return false;
      }
      
      // For today's date, check if current time is past lock time
      const time24 = convert12To24(lockTime);
      const [lockHours, lockMinutes] = time24.split(':');
      const lockDate = new Date(today);
      lockDate.setHours(parseInt(lockHours), parseInt(lockMinutes), 0);
      return now >= lockDate;
    }

    // Get time until lock
    function getTimeUntilLock(date, lockTime) {
      if (!lockTime) return null;
      
      const now = getESTNow();
      const today = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
      
      if (date !== todayStr) return null;
      
      // Convert 12-hour format to 24-hour for calculation
      const time24 = convert12To24(lockTime);
      const [lockHours, lockMinutes] = time24.split(':');
      const lockDate = new Date(today);
      lockDate.setHours(parseInt(lockHours), parseInt(lockMinutes), 0);
      
      if (now >= lockDate) return 0; // Already locked
      
      const diff = lockDate - now;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const secs = Math.floor((diff % (1000 * 60)) / 1000);
      
      return { hours, mins, secs, diff };
    }

    // Format countdown timer display
    function formatCountdown(timeObj) {
      if (!timeObj) return '';
      const { hours, mins, secs } = timeObj;
      if (hours > 0) {
        return `${hours}h ${mins}m ${secs}s`;
      } else if (mins > 0) {
        return `${mins}m ${secs}s`;
      } else {
        return `${secs}s`;
      }
    }

    // Load and display lock time for a date (admin)
    document.getElementById('loadLockTimeBtn').addEventListener('click', async () => {
      if (!checkAdminPermission()) return;
      
      const dateInput = document.getElementById('lockTimeDate').value;
      if (!dateInput) {
        showMessage('‚ùå Please select a date first using the date picker.', 'error', 'lockTimeMessage');
        document.getElementById('lockTimeDate').focus();
        document.getElementById('lockTimeDate').style.borderColor = 'var(--error)';
        return;
      }

      document.getElementById('lockTimeDate').style.borderColor = '';  // Remove error highlight

      try {
        const snapshot = await db.collection('lockTimes').where('date', '==', dateInput).get();
        
        if (snapshot.empty) {
          document.getElementById('lockTimeInput').value = '';
          document.getElementById('lockTimeDisplay').style.display = 'none';
          showMessage(`‚ÑπÔ∏è No lock time set for ${dateInput}. You can create one now.`, 'info', 'lockTimeMessage');
        } else {
          const lockTime = snapshot.docs[0].data().lockTime;
          // Convert stored 12-hour format back to 24-hour for input field
          const time24 = convert12To24(lockTime);
          document.getElementById('lockTimeInput').value = time24;
          document.getElementById('lockTimeDisplayValue').textContent = `${lockTime} EST (for ${dateInput})`;
          document.getElementById('lockTimeDisplay').style.display = 'block';
          showMessage(`‚úÖ Loaded lock time for ${dateInput}`, 'success', 'lockTimeMessage');
        }
      } catch (err) {
        console.error('Error loading lock time:', err);
        showMessage('Error loading lock time: ' + err.message, 'error', 'lockTimeMessage');
      }
    });

    // Save lock time (admin)
    document.getElementById('saveLockTimeBtn').addEventListener('click', async () => {
      if (!checkAdminPermission()) return;
      
      const dateInput = document.getElementById('lockTimeDate').value;
      const lockTime24 = document.getElementById('lockTimeInput').value;
      
      if (!dateInput) {
        showMessage('‚ùå Please select a date first. Use the date picker above.', 'error', 'lockTimeMessage');
        document.getElementById('lockTimeDate').focus();
        document.getElementById('lockTimeDate').style.borderColor = 'var(--error)';
        return;
      }

      if (!lockTime24) {
        showMessage('Please set a lock time', 'error', 'lockTimeMessage');
        return;
      }

      // Validate that the date is actually a valid date format (YYYY-MM-DD)
      if (!/^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
        showMessage('‚ùå Invalid date format. Please use the date picker.', 'error', 'lockTimeMessage');
        return;
      }

      // Convert 24-hour format to 12-hour format for storage
      const lockTime12 = convert24To12(lockTime24);

      try {
        const snapshot = await db.collection('lockTimes').where('date', '==', dateInput).get();
        
        if (!snapshot.empty) {
          await snapshot.docs[0].ref.update({
            date: dateInput,  // Explicitly set date to ensure it's stored
            lockTime: lockTime12,
            updatedAt: new Date().toISOString()
          });
          console.log(`üìù Updated lock time for ${dateInput} to ${lockTime12}`);
        } else {
          await db.collection('lockTimes').add({
            date: dateInput,
            lockTime: lockTime12,
            createdAt: new Date().toISOString()
          });
          console.log(`üÜï Created lock time for ${dateInput}: ${lockTime12}`);
        }

        document.getElementById('lockTimeDisplayValue').textContent = `${lockTime12} EST (for ${dateInput})`;
        document.getElementById('lockTimeDisplay').style.display = 'block';
        document.getElementById('lockTimeDate').style.borderColor = '';  // Remove error highlight
        showMessage(`‚úÖ Lock time saved successfully for ${dateInput}!`, 'success', 'lockTimeMessage');
      } catch (err) {
        console.error('Error saving lock time:', err);
        showMessage('Error saving lock time: ' + err.message, 'error', 'lockTimeMessage');
      }
    });

    // Update lock time date when admin loads a date
    document.getElementById('loadDateBtn').addEventListener('click', function() {
      const adminDate = document.getElementById('adminDate').value;
      if (adminDate) {
        // Auto-populate lock time date when loading questions
        document.getElementById('lockTimeDate').value = adminDate;
        document.getElementById('lockTimeDate').style.borderColor = '';  // Clear any error highlight
        
        // Clear lock time inputs when switching dates to prevent mistakes
        document.getElementById('lockTimeInput').value = '';
        document.getElementById('lockTimeDisplay').style.display = 'none';
        
        showMessage(`üìÖ Lock time date automatically set to ${adminDate}`, 'info', 'lockTimeMessage');
      }
    });

    // Check lock status for users
    async function checkAndDisplayLockStatus(date) {
      try {
        if (!auth.currentUser) {
          return;
        }
        
        const userPicksSnapshot = await db.collection('picks')
          .where('userId', '==', auth.currentUser.uid)
          .where('date', '==', date)
          .get();
        
        const hasSubmitted = !userPicksSnapshot.empty;
        
        const snapshot = await db.collection('lockTimes').where('date', '==', date).get();
        
        if (snapshot.empty) {
          document.getElementById('lockTimeStatus').style.display = 'none';
          document.getElementById('countdownTimer').style.display = 'none';
          if (!hasSubmitted) {
            document.getElementById('submitBtn').disabled = false;
          }
          return;
        }

        const lockTime = snapshot.docs[0].data().lockTime;
        const isLocked = areSubmissionsLocked(date, lockTime);

        if (isLocked) {
          document.getElementById('lockTimeStatus').style.display = 'block';
          document.getElementById('countdownTimer').style.display = 'none';
          document.getElementById('lockTimeStatusMessage').textContent = `Submissions are closed. Lock time was ${lockTime} EST.`;
          if (!hasSubmitted) {
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').textContent = 'Submissions Closed';
          }
        } else {
          const timeUntil = getTimeUntilLock(date, lockTime);
          if (timeUntil && timeUntil.diff > 0) {
            document.getElementById('lockTimeStatus').style.display = 'none';
            document.getElementById('countdownTimer').style.display = 'block';
            document.getElementById('countdownText').textContent = `Submissions close at ${lockTime} EST (${formatCountdown(timeUntil)})`;
            if (!hasSubmitted) {
              document.getElementById('submitBtn').disabled = false;
              document.getElementById('submitBtn').textContent = 'Submit Picks';
            }

            clearInterval(window.countdownInterval);
            window.countdownInterval = setInterval(() => {
              const updated = getTimeUntilLock(date, lockTime);
              if (updated && updated.diff > 0) {
                document.getElementById('countdownText').textContent = `Submissions close at ${lockTime} EST (${formatCountdown(updated)})`;
              } else {
                checkAndDisplayLockStatus(date);
              }
            }, 1000);
          } else {
            document.getElementById('lockTimeStatus').style.display = 'none';
            document.getElementById('countdownTimer').style.display = 'none';
          }
        }
      } catch (err) {
        console.error('Error checking lock status:', err);
        document.getElementById('lockTimeStatus').style.display = 'none';
        document.getElementById('countdownTimer').style.display = 'none';
      }
    }

    // === Mark Correct Answers ===


    // Calculate scores based on user picks and correct answers
    async function calculateScoresForDate(date, weekNumberFilter = null) {
      try {
        console.log(`üìä calculateScoresForDate called for date: ${date}${weekNumberFilter ? ` (Week filter: ${weekNumberFilter})` : ''}`);
        
        // Get questions for the date
        const questionsSnapshot = await db.collection('questions').where('date', '==', date).get();
        console.log(`  üìö Found ${questionsSnapshot.size} question documents for date ${date}`);
        if (questionsSnapshot.empty) {
          console.warn(`  ‚ö†Ô∏è No questions found for date ${date} - cannot calculate scores`);
          return [];
        }

        const doc = questionsSnapshot.docs[0];
        let questions = doc.data().items || [];
        
        // Filter by week number if specified (for weekly leaderboards)
        if (weekNumberFilter !== null) {
          console.log(`  üîç Week filter: ${weekNumberFilter} (type: ${typeof weekNumberFilter})`);
          console.log(`  üìã All questions weekNumbers:`, questions.map(q => ({q: q.question.substring(0, 30), wn: q.weekNumber, type: typeof q.weekNumber})));
          questions = questions.filter(q => q.weekNumber === weekNumberFilter || q.weekNumber == weekNumberFilter);
          console.log(`  ‚úÖ Filtered to ${questions.length} questions for Week ${weekNumberFilter}`);
        }
        
        console.log(`  ‚úÖ Loaded ${questions.length} questions for date ${date}`);

        // Get correct answers
        const answersSnapshot = await db.collection('correctAnswers').where('date', '==', date).get();
        console.log(`  üìù Found ${answersSnapshot.size} correct answer document(s) for date ${date}`);
        if (answersSnapshot.empty) {
          console.warn(`  ‚ö†Ô∏è No correct answers found for date ${date}. Scores cannot be calculated.`);
          return [];
        }

        const correctAnswersDoc = answersSnapshot.docs[0].data();
        const correctAnswersMap = {};
        const questionMetadataMap = {};
        
        // Build map of question index to metadata (for week filtering)
        questions.forEach((q, idx) => {
          questionMetadataMap[idx] = { weekNumber: q.weekNumber };
        });
        
        if (correctAnswersDoc.answers && Array.isArray(correctAnswersDoc.answers)) {
          correctAnswersDoc.answers.forEach(a => {
            if (a && typeof a === 'object' && a.questionId !== undefined && a.correctAnswer !== undefined) {
              correctAnswersMap[a.questionId] = a.correctAnswer;
              console.log(`    Q${a.questionId}: ${a.correctAnswer}`);
            }
          });
          console.log(`  ‚úÖ Loaded ${Object.keys(correctAnswersMap).length} correct answers`);
          
          if (Object.keys(correctAnswersMap).length === 0) {
            console.warn(`  ‚ö†Ô∏è Answer array exists but no valid answers found`);
            console.log(`  üìä Raw answers doc:`, correctAnswersDoc);
            return [];
          }
        } else {
          console.warn(`  ‚ö†Ô∏è answers field is missing or not an array in correctAnswers doc`);
          console.log(`  üìä Raw answers doc:`, correctAnswersDoc);
          return [];
        }

        // Get all picks for this date
        const picksSnapshot = await db.collection('picks').where('date', '==', date).get();
        console.log(`  üó≥Ô∏è Found ${picksSnapshot.size} pick documents for date ${date}`);
        console.log(`  üìä [DEBUG] Checking all picks in database...`);
        const allPicksSnapshot = await db.collection('picks').get();
        console.log(`  üìä [DEBUG] Total picks in database: ${allPicksSnapshot.size}`);
        if (allPicksSnapshot.size > 0) {
          console.log(`  üìä [DEBUG] Sample dates from picks:`, allPicksSnapshot.docs.slice(0, 5).map(d => d.data().date));
        }
        
        if (picksSnapshot.empty) {
          console.warn(`  ‚ö†Ô∏è No user picks found for date ${date}`);
          return [];
        }
        
        const userScores = {};
        
        // Get ALL questions for this date (unfiltered) to map original indices
        const allQuestionsSnapshot = await db.collection('questions').where('date', '==', date).get();
        const allQuestions = allQuestionsSnapshot.empty ? [] : allQuestionsSnapshot.docs[0].data().items || [];
        
        // Determine which question indices to count based on week filter
        const questionIndicesToCount = weekNumberFilter !== null 
          ? allQuestions.map((q, idx) => q.weekNumber === weekNumberFilter ? idx : -1).filter(idx => idx !== -1)
          : allQuestions.map((q, idx) => idx);
        
        const totalQuestionsForScoring = questionIndicesToCount.length;
        console.log(`  üìä Will score ${totalQuestionsForScoring} questions (${weekNumberFilter ? `Week ${weekNumberFilter} filter applied` : 'no week filter'})`);
        
        picksSnapshot.forEach(pickDoc => {
          const pickData = pickDoc.data();
          const userId = pickData.userId;
          const username = pickData.username || pickData.userEmail || userId;
          
          if (!userScores[userId]) {
            userScores[userId] = {
              username: username,
              correct: 0,
              total: totalQuestionsForScoring * 10
            };
          }

          // Iterate through each answer for this user
          const userAnswers = pickData.answers || [];
          console.log(`    üë§ ${username}: ${userAnswers.length} answers`);
          let userCorrectCount = 0;
          let questionsChecked = 0;
          let questionsMatched = 0;
          
          userAnswers.forEach((userPick, qIdx) => {
            // Only count if this question index is in our list to count
            if (!questionIndicesToCount.includes(qIdx)) {
              return;
            }
            
            questionsChecked++;
            const correctAnswer = correctAnswersMap[qIdx];
            
            // Normalize comparison for numeric vs string types
            let isCorrect = false;
            if (userPick !== undefined && correctAnswer !== undefined) {
              questionsMatched++;
              // Normalize values for comparison
              let normalizedPick = userPick;
              let normalizedAnswer = correctAnswer;
              
              // Convert booleans to lowercase strings
              if (typeof userPick === 'boolean') normalizedPick = userPick.toString().toLowerCase();
              if (typeof correctAnswer === 'boolean') normalizedAnswer = correctAnswer.toString().toLowerCase();
              
              // Convert to lowercase strings and trim whitespace
              normalizedPick = String(normalizedPick).trim().toLowerCase();
              normalizedAnswer = String(normalizedAnswer).trim().toLowerCase();
              
              // Handle numeric comparisons
              if (!isNaN(parseFloat(normalizedPick)) && !isNaN(parseFloat(normalizedAnswer))) {
                isCorrect = parseFloat(normalizedPick) === parseFloat(normalizedAnswer);
              } else {
                isCorrect = normalizedPick === normalizedAnswer;
              }
              
              if (isCorrect) {
                userCorrectCount++;
              }
            } else {
              console.warn(`Q${qIdx} MISSING: userPick=${userPick}, correctAnswer=${correctAnswer}`);
            }
          });
          
          userScores[userId].correct = userCorrectCount * 10;
          console.log(`  ‚úÖ ${username}: ${userCorrectCount} correct out of ${questionsMatched} with answers (checked ${questionsChecked} questions)`);
        });

        let overridesMap = {};
        try {
          const overridesSnapshot = await db.collection('scoreOverrides').where('date', '==', date).get();
          overridesSnapshot.forEach(doc => {
            const data = doc.data();
            overridesMap[data.userEmail] = data.score;
          });
        } catch (overrideErr) {
          console.warn(`  ‚ö†Ô∏è Could not fetch score overrides (permissions issue):`, overrideErr.message);
        }
        
        const scoresArray = Object.entries(userScores).map(([userId, score]) => {
          const userEmail = score.username;
          console.log(`  üìä FINAL: ${score.username} = ${score.correct}/${score.total}`);
          if (overridesMap[userEmail] !== undefined) {
            console.log(`  üîß Override applied for ${userEmail}: ${score.correct} ‚Üí ${overridesMap[userEmail]}`);
            return {
              username: score.username,
              correct: overridesMap[userEmail],
              total: score.total,
              isOverridden: true
            };
          }
          return {
            username: score.username,
            correct: score.correct,
            total: score.total,
            isOverridden: false
          };
        });
        
        const finalScores = scoresArray
          .sort((a, b) => b.correct - a.correct)
          .map((score, idx) => ({
            rank: idx + 1,
            username: score.username,
            correct: score.correct,
            total: score.total,
            percentage: score.total > 0 ? ((score.correct / score.total) * 100).toFixed(1) : 0,
            isOverridden: score.isOverridden
          }));
        
        console.log(`  ‚úÖ Returning ${finalScores.length} final scores:`, finalScores);
        return finalScores;
      } catch (err) {
        console.error('Error calculating scores:', err);
        return [];
      }
    }

    // Load submissions for deletion
    async function loadSubmissionsForDelete(date) {
      try {
        showMessage('Loading submissions...', 'info', 'submissionsMessage');
        
        const picksSnapshot = await db.collection('picks').where('date', '==', date).get();
        
        if (picksSnapshot.empty) {
          document.getElementById('deleteSubmissionsTable').style.display = 'none';
          document.getElementById('noSubmissionsForDeleteMessage').style.display = 'block';
          showMessage('No submissions found for this date', 'info', 'submissionsMessage');
          return;
        }

        const tbody = document.getElementById('deleteSubmissionsTableBody');
        tbody.innerHTML = picksSnapshot.docs.map(doc => {
          const data = doc.data();
          const userEmail = data.userEmail || data.username || data.userId;
          const answerCount = (data.answers || []).length;
          
          return `
            <tr style="border-bottom: 1px solid var(--border); background: ${picksSnapshot.docs.indexOf(doc) % 2 === 0 ? 'transparent' : 'rgba(0,0,0,0.02)'};">
              <td style="padding: 14px; font-weight: 600; color: var(--brand);">${userEmail}</td>
              <td style="padding: 14px; text-align: center; font-weight: 600;">${answerCount}</td>
              <td style="padding: 14px; text-align: center;">
                <button class="btn btn-danger delete-submission-btn" data-doc-id="${doc.id}" style="padding: 8px 16px; font-size: 0.85rem; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;">
                  üóëÔ∏è Delete
                </button>
              </td>
            </tr>
          `;
        }).join('');

        document.getElementById('deleteSubmissionsTable').style.display = 'table';
        document.getElementById('noSubmissionsForDeleteMessage').style.display = 'none';
        showMessage(`‚úÖ Loaded ${picksSnapshot.size} submission(s)`, 'success', 'submissionsMessage');

        // Add event listeners to delete buttons
        document.querySelectorAll('.delete-submission-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const docId = e.target.dataset.docId;
            if (confirm('Are you sure you want to delete this submission? This cannot be undone.')) {
              await deleteSubmission(docId, date);
            }
          });
        });
      } catch (err) {
        console.error('Error loading submissions:', err);
        showMessage('Error loading submissions: ' + err.message, 'error', 'submissionsMessage');
      }
    }

    // Delete individual submission
    async function deleteSubmission(docId, date) {
      try {
        showMessage('Deleting submission...', 'info', 'submissionsMessage');
        await db.collection('picks').doc(docId).delete();
        showMessage('‚úÖ Submission deleted successfully!', 'success', 'submissionsMessage');
        
        // Reload the table
        await loadSubmissionsForDelete(date);
      } catch (err) {
        console.error('Error deleting submission:', err);
        showMessage('Error deleting submission: ' + err.message, 'error', 'submissionsMessage');
      }
    }

    // Tab switching for submissions view
    document.getElementById('viewResponsesTabBtn').addEventListener('click', () => {
      document.getElementById('responsesViewTab').style.display = 'block';
      document.getElementById('deleteViewTab').style.display = 'none';
      
      document.getElementById('viewResponsesTabBtn').style.background = '#e0e7ff';
      document.getElementById('viewResponsesTabBtn').style.color = 'var(--brand)';
      document.getElementById('viewResponsesTabBtn').style.border = '2px solid var(--brand)';
      
      document.getElementById('deleteSubmissionsTabBtn').style.background = 'transparent';
      document.getElementById('deleteSubmissionsTabBtn').style.color = 'var(--muted)';
      document.getElementById('deleteSubmissionsTabBtn').style.border = 'none';
    });

    document.getElementById('deleteSubmissionsTabBtn').addEventListener('click', () => {
      document.getElementById('responsesViewTab').style.display = 'none';
      document.getElementById('deleteViewTab').style.display = 'block';
      
      document.getElementById('deleteSubmissionsTabBtn').style.background = '#e0e7ff';
      document.getElementById('deleteSubmissionsTabBtn').style.color = 'var(--brand)';
      document.getElementById('deleteSubmissionsTabBtn').style.border = '2px solid var(--brand)';
      
      document.getElementById('viewResponsesTabBtn').style.background = 'transparent';
      document.getElementById('viewResponsesTabBtn').style.color = 'var(--muted)';
      document.getElementById('viewResponsesTabBtn').style.border = 'none';
    });

    // Load submissions button for unified interface
    document.getElementById('loadSubmissionsBtn').addEventListener('click', async () => {
      if (!checkAdminPermission()) return;
      
      const dateInput = document.getElementById('submissionsDate').value;
      if (!dateInput) {
        showMessage('Please select a date first', 'error', 'submissionsMessage');
        return;
      }
      
      // Load both views based on active tab
      const isResponsesView = document.getElementById('responsesViewTab').style.display !== 'none';
      
      if (isResponsesView) {
        await loadUserResponses(dateInput);
      } else {
        await loadSubmissionsForDelete(dateInput);
      }
    });

    // Load User Responses
    async function loadUserResponses(dateInput) {
      if (!checkAdminPermission()) return;

      try {
        showMessage('Loading responses...', 'info', 'submissionsMessage');
        
        // Get questions for this date
        const questionsSnapshot = await db.collection('questions').where('date', '==', dateInput).get();
        if (questionsSnapshot.empty) {
          showMessage('No questions found for this date', 'error', 'submissionsMessage');
          document.getElementById('responsesTable').style.display = 'none';
          document.getElementById('noResponsesMessage').style.display = 'block';
          return;
        }

        const questionDoc = questionsSnapshot.docs[0].data();
        const questions = questionDoc.items || [];

        // Get correct answers for this date
        const answersSnapshot = await db.collection('correctAnswers').where('date', '==', dateInput).get();
        let correctAnswers = {};
        if (!answersSnapshot.empty) {
          const answersDoc = answersSnapshot.docs[0].data();
          answersDoc.answers.forEach(ans => {
            correctAnswers[ans.questionId] = ans.correctAnswer;
          });
        }

        // Get all picks for this date
        const picksSnapshot = await db.collection('picks').where('date', '==', dateInput).get();
        
        if (picksSnapshot.empty) {
          showMessage('No user responses for this date', 'info', 'submissionsMessage');
          document.getElementById('responsesTable').style.display = 'none';
          document.getElementById('noResponsesMessage').style.display = 'block';
          return;
        }

        const container = document.getElementById('responsesContainer');
        container.innerHTML = '';
        
        picksSnapshot.docs.forEach(doc => {
          const pickData = doc.data();
          let correctCount = 0;
          let totalAnswered = 0;
          
          const questionsHtml = questions.map((q, qIdx) => {
            const userPick = pickData.answers && pickData.answers[qIdx] !== undefined ? pickData.answers[qIdx] : '-';
            const correctAnswer = correctAnswers[qIdx] !== undefined ? correctAnswers[qIdx] : '(Not Set)';
            
            let isCorrect = false;
            if (userPick !== '-' && correctAnswer !== '(Not Set)') {
              if (typeof userPick === 'number' || typeof correctAnswer === 'number') {
                isCorrect = parseFloat(userPick) === parseFloat(correctAnswer);
              } else {
                isCorrect = userPick === correctAnswer;
              }
              if (isCorrect) correctCount++;
              totalAnswered++;
            }
            
            const status = correctAnswers[qIdx] === undefined ? '‚è≥' : (isCorrect ? '‚úÖ' : '‚ùå');
            const statusColor = isCorrect ? '#27ae60' : (correctAnswers[qIdx] === undefined ? '#f39c12' : '#e74c3c');
            const bgColor = isCorrect ? 'rgba(39, 174, 96, 0.1)' : (correctAnswers[qIdx] === undefined ? 'rgba(243, 156, 18, 0.1)' : 'rgba(231, 76, 60, 0.1)');

            return `
              <div style="background: ${bgColor}; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${statusColor};">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                  <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--ink); margin-bottom: 4px;">Q${qIdx + 1}: ${q.question}</div>
                    <div style="display: flex; gap: 2rem; margin-top: 8px; font-size: 0.9rem;">
                      <div><span style="color: var(--muted);">User's Pick:</span> <strong>${userPick}</strong></div>
                      <div><span style="color: var(--muted);">Correct:</span> <strong>${correctAnswer}</strong></div>
                    </div>
                  </div>
                  <div style="font-size: 24px;">${status}</div>
                </div>
              </div>
            `;
          }).join('');
          
          const scoreDisplay = totalAnswered > 0 ? `${correctCount}/${totalAnswered}` : 'No answers graded yet';
          const scoreColor = totalAnswered > 0 ? (correctCount / totalAnswered >= 0.7 ? '#27ae60' : correctCount / totalAnswered >= 0.5 ? '#f39c12' : '#e74c3c') : '#64748b';
          
          const userCard = document.createElement('div');
          userCard.style.cssText = 'background: white; border: 2px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);';
          userCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border);">
              <div>
                <div style="font-size: 1.1rem; font-weight: 700; color: var(--brand);">${pickData.userEmail || pickData.username || pickData.userId}</div>
                <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px;">Submitted: ${new Date(pickData.submittedAt).toLocaleString()}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 4px;">Score</div>
                <div style="font-size: 1.5rem; font-weight: 900; color: ${scoreColor};">${scoreDisplay}</div>
              </div>
            </div>
            ${questionsHtml}
          `;
          container.appendChild(userCard);
        });

        document.getElementById('responsesContainer').style.display = 'block';
        document.getElementById('noResponsesMessage').style.display = 'none';
        showMessage(`‚úÖ Loaded ${picksSnapshot.size} user submissions`, 'success', 'submissionsMessage');
      } catch (err) {
        console.error('Error loading responses:', err);
        showMessage('Error loading responses: ' + err.message, 'error', 'submissionsMessage');
        document.getElementById('responsesTable').style.display = 'none';
        document.getElementById('noResponsesMessage').style.display = 'block';
      }
    }

    // === Questions & Picks ===
    async function loadQuestionsForDate(dateStr, weekNumber = null) {
      if (!currentUser) return;
      try {
        console.log(`üìã Loading questions for date: ${dateStr} (type: ${typeof dateStr}), week: ${weekNumber || 'any'}`);
        selectedPickDate = dateStr;
        
        // Show loading state
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '<div class="loading-state">üìã Loading questions...</div>';
        
        // Debug: Check all questions in collection
        const allDocs = await db.collection('questions').get();
        console.log(`üìä DEBUG - Total questions documents in collection: ${allDocs.size}`);
        allDocs.forEach(doc => {
          const data = doc.data();
          console.log(`  Document - Date: "${data.date}" (type: ${typeof data.date}), Items count: ${data.items?.length || 0}`);
        });
        
        const snapshot = await db.collection('questions').where('date', '==', dateStr).get();
        
        console.log(`Found ${snapshot.size} document(s) matching query for ${dateStr}`);
        
        if (snapshot.empty) {
          console.warn(`‚ö†Ô∏è No questions found for ${dateStr}`);
          console.warn(`  Searched for exact match: "${dateStr}"`);
          console.warn(`  Are there any questions saved at all? Check collection above.`);
          todayQuestions = [];
          renderQuestions();
          return;
        }

        const docs = snapshot.docs;
        if (docs.length > 0) {
          const questionData = docs[0].data();
          let allQuestions = questionData.items || [];
          
          if (weekNumber !== null) {
            todayQuestions = allQuestions.filter(q => q.weekNumber === weekNumber);
            console.log(`‚úÖ Loaded ${todayQuestions.length}/${allQuestions.length} questions for ${dateStr} (Week ${weekNumber}):`, todayQuestions);
          } else {
            todayQuestions = allQuestions;
            console.log(`‚úÖ Loaded ${todayQuestions.length} questions for ${dateStr}:`, todayQuestions);
          }
        }
        
        renderQuestions();
        
        // Check if already submitted for this date
        await checkSubmissionForDate(dateStr);

        // Check and display lock status for this date
        await checkAndDisplayLockStatus(dateStr);
      } catch (err) {
        console.error('Error loading questions:', err);
        console.error('Error details:', err.message);
        showMessage('Could not load questions. Please try again.', 'error');
      }
    }

    function renderQuestions() {
      const container = document.getElementById('questionsContainer');
      
      if (todayQuestions.length === 0) {
        console.warn('‚ö†Ô∏è renderQuestions called with 0 questions');
        console.warn(`  Current date: ${selectedPickDate}`);
        console.warn(`  todayQuestions array: ${JSON.stringify(todayQuestions)}`);
        container.innerHTML = '<div class="empty-state">No questions available today. Check back later!</div>';
        document.getElementById('submitBtn').disabled = true;
        return;
      }
      
      console.log(`üé® Rendering ${todayQuestions.length} questions to the page for date ${selectedPickDate}`);
      console.log(`   Questions: ${JSON.stringify(todayQuestions)}`);
      console.log(`   Container ID: ${container.id}, exists: ${!!container}`);

      container.innerHTML = todayQuestions.map((q, i) => {
        let optionsHtml = '';

        if (q.question_type === 'yes_no') {
          optionsHtml = `
            <label class="option radio-option">
              <input type="radio" name="q${i}" value="Yes">
              <span>Yes</span>
            </label>
            <label class="option radio-option">
              <input type="radio" name="q${i}" value="No">
              <span>No</span>
            </label>
          `;
        } else if (q.question_type === 'multiple_choice') {
          // Parse comma-separated options
          const options = q.options ? q.options.split(',').map(opt => opt.trim()) : [];
          optionsHtml = options.map(opt => `
            <label class="option radio-option">
              <input type="radio" name="q${i}" value="${opt}">
              <span>${opt}</span>
            </label>
          `).join('');
        } else if (q.question_type === 'numeric') {
          optionsHtml = `
            <input type="number" name="q${i}" class="text-input" placeholder="Enter your answer">
          `;
        }

        return `
          <div class="question-card" data-index="${i}">
            <div class="question-number">Question ${i + 1}</div>
            <div class="question-text">${q.question}</div>
            <div class="options">${optionsHtml}</div>
          </div>
        `;
      }).join('');

      console.log(`‚úÖ HTML rendered to container. DOM update complete.`);
      console.log(`   Question cards in DOM: ${document.querySelectorAll('.question-card').length}`);

      document.querySelectorAll('input[name^="q"]').forEach(input => {
        input.addEventListener('change', updateProgress);
      });
      
      console.log(`‚úÖ Event listeners attached to ${document.querySelectorAll('input[name^="q"]').length} input elements`);
    }

    function updateProgress() {
      const total = todayQuestions.length;
      let answered = 0;
      
      todayQuestions.forEach((q, i) => {
        const input = document.querySelector(`input[name="q${i}"]`);
        if (input && input.type === 'radio') {
          const checked = document.querySelector(`input[name="q${i}"]:checked`);
          if (checked) {
            answered++;
            document.querySelector(`[data-index="${i}"]`)?.classList.add('answered');
          } else {
            document.querySelector(`[data-index="${i}"]`)?.classList.remove('answered');
          }
        } else if (input && input.value) {
          answered++;
          document.querySelector(`[data-index="${i}"]`)?.classList.add('answered');
        } else {
          document.querySelector(`[data-index="${i}"]`)?.classList.remove('answered');
        }
      });
      
      const percent = (answered / total) * 100;
      document.getElementById('progressFill').style.width = percent + '%';
    }

    async function checkSubmissionForDate(dateStr) {
      if (!auth.currentUser) {
        console.log('‚è≥ checkSubmissionForDate: auth.currentUser not ready yet');
        return;
      }
      try {
        console.log(`üîç Checking submission for userId: ${auth.currentUser.uid}, date: ${dateStr}`);
        
        const lockSnapshot = await db.collection('lockTimes').where('date', '==', dateStr).get();
        let isLocked = false;
        let lockTime = null;
        
        if (!lockSnapshot.empty) {
          lockTime = lockSnapshot.docs[0].data().lockTime;
          isLocked = areSubmissionsLocked(dateStr, lockTime);
          console.log(`üîí Lock time found: ${lockTime}, isLocked: ${isLocked}`);
        }
        
        const snapshot = await db.collection('picks').where('userId', '==', auth.currentUser.uid).where('date', '==', dateStr).get();
        
        console.log(`üìä Query returned ${snapshot.size} document(s)`);
        if (!snapshot.empty) {
          const picks = snapshot.docs[0].data().answers || [];
          console.log(`‚úÖ Found previous submission with ${picks.length} answers`);
          picks.forEach((answer, i) => {
            const input = document.querySelector(`input[name="q${i}"]`);
            if (input && input.type === 'radio') {
              const radioToCheck = document.querySelector(`input[name="q${i}"][value="${answer}"]`);
              if (radioToCheck) {
                radioToCheck.checked = true;
              }
            } else if (input && input.type === 'number') {
              input.value = answer;
            }
          });
          
          document.getElementById('submitBtn').disabled = true;
          document.getElementById('submitBtn').textContent = 'Already Submitted for This Date';
          showMessage('You have already submitted your picks for this date!', 'success');
        } else if (isLocked) {
          console.log(`üîí Date is locked but no submission found - disabling submit button`);
          document.getElementById('submitBtn').disabled = true;
          document.getElementById('submitBtn').textContent = 'Submissions Closed';
        } else {
          console.log('‚ùå No previous submission found and not locked');
          document.getElementById('submitBtn').disabled = false;
          document.getElementById('submitBtn').textContent = 'Submit Picks';
        }
      } catch (err) {
        console.error('‚ùå Error checking submission:', err);
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').textContent = 'Submit Picks';
      }
    }

    document.getElementById('submitBtn').addEventListener('click', async () => {
      if (!auth.currentUser) {
        showMessage('Not logged in', 'error');
        return;
      }

      if (!selectedPickDate) {
        showMessage('Please select a game date', 'error');
        return;
      }

      // Check if submissions are locked
      try {
        console.log(`üîí Checking lock status for date: ${selectedPickDate}`);
        const lockSnapshot = await db.collection('lockTimes').where('date', '==', selectedPickDate).get();
        if (!lockSnapshot.empty) {
          const lockTime = lockSnapshot.docs[0].data().lockTime;
          const isLocked = areSubmissionsLocked(selectedPickDate, lockTime);
          console.log(`üîí Lock time found: ${lockTime}, isLocked: ${isLocked}`);
          if (isLocked) {
            console.log(`‚ùå Submissions BLOCKED - date is locked`);
            showMessage('‚è∞ Submissions are closed for this date.', 'error');
            return;
          }
        } else {
          console.log(`‚ÑπÔ∏è No lock time set for ${selectedPickDate}, allowing submission`);
        }
      } catch (err) {
        console.error('Error checking lock time:', err);
      }

      const answers = [];
      let allAnswered = true;

      todayQuestions.forEach((q, i) => {
        const input = document.querySelector(`input[name="q${i}"]`);
        if (input && input.type === 'radio') {
          const checked = document.querySelector(`input[name="q${i}"]:checked`);
          if (checked) {
            answers.push(checked.value);
          } else {
            allAnswered = false;
          }
        } else if (input && input.type === 'number') {
          if (input.value) {
            answers.push(parseFloat(input.value));
          } else {
            allAnswered = false;
          }
        } else {
          allAnswered = false;
        }
      });

      if (!allAnswered) {
        showMessage('Please answer all questions', 'error');
        return;
      }

      try {
        console.log(`üíæ Submitting picks for date: ${selectedPickDate}, userId: ${auth.currentUser.uid}`);
        console.log(`   Answers: ${JSON.stringify(answers)}`);
        
        const existingPicksSnapshot = await db.collection('picks')
          .where('userId', '==', auth.currentUser.uid)
          .where('date', '==', selectedPickDate)
          .get();
        
        if (!existingPicksSnapshot.empty) {
          console.log(`‚ö†Ô∏è User already has a submission for this date - preventing duplicate`);
          document.getElementById('submitBtn').disabled = true;
          document.getElementById('submitBtn').textContent = 'Already Submitted for This Date';
          return;
        }
        
        const pickRef = await db.collection('picks').add({
          userId: auth.currentUser.uid,
          username: currentUser,
          userEmail: auth.currentUser.email,
          date: selectedPickDate,
          answers: answers,
          submittedAt: new Date().toISOString()
        });

        console.log(`‚úÖ Picks saved with doc ID: ${pickRef.id}`);
        showMessage('‚úÖ Picks submitted successfully!', 'success');
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').textContent = 'Already Submitted for This Date';
      } catch (err) {
        console.error('Error saving picks:', err);
        showMessage(err.message || 'Submission failed', 'error');
      }
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      document.querySelectorAll('input[name^="q"]').forEach(input => {
        input.value = '';
        input.checked = false;
      });
      updateProgress();
    });

    // === ESPN-Style Date Slider ===
    let currentDateOffset = 0;
    const DATES_TO_SHOW = 7;
    const PAST_DAYS = 30;
    const FUTURE_DAYS = 14;

    function formatDateLabel(date) {
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const dayOfWeek = dayNames[date.getDay()];
      const month = monthNames[date.getMonth()];
      const day = date.getDate();
      // Return object with separate day and date parts
      return {
        day: dayOfWeek,
        date: `${month} ${day}`
      };
    }

    // Format date for comparison using LOCAL timezone (not UTC)
    function formatDateForComparison(date) {
      // Pad month and day with leading zeros
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function renderDateSlider() {
      const container = document.getElementById('datePickerContainer');
      const today = new Date();
      const dates = [];

      // Generate past days (30 days back) and future days (14 days forward)
      for (let i = -PAST_DAYS; i < FUTURE_DAYS; i++) {
        const date = new Date(today);
        date.setDate(date.getDate() + i);
        const formattedValue = formatDateForComparison(date);
        dates.push({
          date: date,
          label: formatDateLabel(date),
          value: formattedValue,
          dayNum: date.getDate()
        });
      }

      // Show DATES_TO_SHOW dates at a time
      const visibleDates = dates.slice(currentDateOffset, currentDateOffset + DATES_TO_SHOW);

      container.innerHTML = visibleDates.map(d => {
        const isActive = document.getElementById('pickDate').value === d.value;
        return `
          <button class="date-picker-btn ${isActive ? 'active' : ''}" data-date="${d.value}">
            <div style="font-weight: 700; font-size: 12px;">${d.label.day}</div>
            <div class="date-picker-date">${d.label.date}</div>
          </button>
        `;
      }).join('');

      // Update nav button states
      document.getElementById('prevDateBtn').disabled = currentDateOffset === 0;
      document.getElementById('nextDateBtn').disabled = currentDateOffset >= dates.length - DATES_TO_SHOW;

      // Attach click handlers to date buttons
      container.querySelectorAll('.date-picker-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const dateValue = btn.dataset.date;
          const selectedWeek = document.getElementById('selectedPickWeek').value ? parseInt(document.getElementById('selectedPickWeek').value) : null;
          document.getElementById('pickDate').value = dateValue;
          renderDateSlider();
          loadQuestionsForDate(dateValue, selectedWeek);
        });
      });
    }

    document.getElementById('prevDateBtn').addEventListener('click', () => {
      if (currentDateOffset > 0) {
        currentDateOffset--;
        renderDateSlider();
      }
    });

    document.getElementById('nextDateBtn').addEventListener('click', () => {
      const totalDates = PAST_DAYS + FUTURE_DAYS;
      if (currentDateOffset < totalDates - DATES_TO_SHOW) {
        currentDateOffset++;
        renderDateSlider();
      }
    });

    // Initialize date slider using timezone-safe formatting
    const todayForInit = new Date();
    const todayFormatted = formatDateForComparison(todayForInit);
    console.log(`üöÄ PAGE INITIALIZATION: Loading picks for today: ${todayFormatted}`);
    document.getElementById('pickDate').value = todayFormatted;
    // Start offset so today is visible (PAST_DAYS ensures today is at position PAST_DAYS in the array)
    currentDateOffset = PAST_DAYS;
    renderDateSlider();
    console.log(`üìÖ Date slider rendered. Loading questions for: ${todayFormatted}`);
    loadQuestionsForDate(todayFormatted);

    // === Daily Leaderboard Date Picker ===
    let currentDailyDateOffset = 0;
    
    function renderDailyDatePicker() {
      console.log('üóìÔ∏è renderDailyDatePicker called');
      const container = document.getElementById('dailyDatePickerContainer');
      if (!container) {
        console.error('‚ùå dailyDatePickerContainer not found!');
        return;
      }
      const today = new Date();
      const dates = [];
      console.log(`üìÖ Generating daily dates from ${today.toISOString().split('T')[0]} minus ${PAST_DAYS} days...`);

      // Generate past days (30 days back) and future days (about 200 days forward)
      const startDate = new Date(today);
      startDate.setDate(startDate.getDate() - PAST_DAYS);
      const endDate = new Date(today);
      endDate.setDate(endDate.getDate() + 200);
      
      let currentDate = new Date(startDate);
      while (currentDate <= endDate) {
        const formattedValue = formatDateForComparison(currentDate);
        dates.push({
          date: new Date(currentDate),
          label: formatDateLabel(currentDate),
          value: formattedValue,
          dayNum: currentDate.getDate()
        });
        currentDate.setDate(currentDate.getDate() + 1);
      }

      // Show DATES_TO_SHOW dates at a time
      const visibleDates = dates.slice(currentDailyDateOffset, currentDailyDateOffset + DATES_TO_SHOW);

      container.innerHTML = visibleDates.map(d => {
        const currentDailyLbDate = document.getElementById('dailyLbDate').value;
        const isActive = currentDailyLbDate === d.value;
        return `
          <button class="date-picker-btn ${isActive ? 'active' : ''}" data-daily-date="${d.value}">
            <div style="font-weight: 700; font-size: 12px;">${d.label.day}</div>
            <div class="date-picker-date">${d.label.date}</div>
          </button>
        `;
      }).join('');

      // Update nav button states
      document.getElementById('prevDailyDateBtn').disabled = currentDailyDateOffset === 0;
      document.getElementById('nextDailyDateBtn').disabled = currentDailyDateOffset >= dates.length - DATES_TO_SHOW;

      // Attach click handlers to date buttons
      container.querySelectorAll('.date-picker-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const dateValue = btn.dataset.dailyDate;
          document.getElementById('dailyLbDate').value = dateValue;
          renderDailyDatePicker();
          loadLeaderboard('daily', null, null, dateValue);
        });
      });
    }

    document.getElementById('prevDailyDateBtn').addEventListener('click', () => {
      if (currentDailyDateOffset > 0) {
        currentDailyDateOffset--;
        renderDailyDatePicker();
      }
    });

    document.getElementById('nextDailyDateBtn').addEventListener('click', () => {
      const today = new Date();
      const startDate = new Date(today);
      startDate.setDate(startDate.getDate() - PAST_DAYS);
      const endDate = new Date(today);
      endDate.setDate(endDate.getDate() + 200);
      
      let currentDate = new Date(startDate);
      let totalDates = 0;
      while (currentDate <= endDate) {
        totalDates++;
        currentDate.setDate(currentDate.getDate() + 1);
      }
      
      if (currentDailyDateOffset < totalDates - DATES_TO_SHOW) {
        currentDailyDateOffset++;
        renderDailyDatePicker();
      }
    });

    // === Week and Month Sliders ===
    let currentWeekOffset = 0;
    let currentMonthOffset = 0;
    const WEEKS_TO_SHOW = 5;
    const MONTHS_TO_SHOW = 4;
    let selectedWeek = null;
    let selectedMonth = 0;
    
    // Initialize daily leaderboard date
    const todayForDailyLb = formatDateForComparison(new Date());
    document.getElementById('dailyLbDate').value = todayForDailyLb;
    currentDailyDateOffset = PAST_DAYS;

    function renderWeekSlider() {
      console.log('üìÖ renderWeekSlider called');
      const container = document.getElementById('weekPickerContainer');
      if (!container) {
        console.error('‚ùå weekPickerContainer not found!');
        return;
      }
      
      const weeks = [];
      for (let i = 1; i <= 20; i++) {
        weeks.push({
          value: i,
          label: `Week ${i}`
        });
      }

      if (selectedWeek === null && weeks.length > 0) {
        selectedWeek = weeks[1].value;
      }

      const visibleWeeks = weeks.slice(currentWeekOffset, currentWeekOffset + WEEKS_TO_SHOW);

      if (visibleWeeks.length > 0 && !visibleWeeks.some(w => w.value === selectedWeek)) {
        selectedWeek = visibleWeeks[0].value;
        console.log(`‚ö†Ô∏è Selected week not in visible range. Adjusted selectedWeek to ${selectedWeek}`);
      }

      container.innerHTML = visibleWeeks.map(w => {
        const isActive = selectedWeek === w.value;
        return `
          <button class="date-picker-btn ${isActive ? 'active' : ''}" data-week="${w.value}">
            <div style="font-weight: 700; font-size: 12px;">${w.label}</div>
          </button>
        `;
      }).join('');

      document.getElementById('prevWeekBtn').style.display = currentWeekOffset > 0 ? 'flex' : 'none';
      document.getElementById('nextWeekBtn').style.display = currentWeekOffset < weeks.length - WEEKS_TO_SHOW ? 'flex' : 'none';

      container.querySelectorAll('.date-picker-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedWeek = parseInt(btn.dataset.week);
          renderWeekSlider();
          loadLeaderboard('weekly', selectedWeek);
        });
      });

      if (selectedWeek !== null) {
        console.log(`üìÖ Auto-loading weekly leaderboard for Week ${selectedWeek}`);
        loadLeaderboard('weekly', selectedWeek);
      }
    }

    let currentPickWeekOffset = 0;
    
    function renderPickWeekPicker() {
      return;
    }

    function renderMonthSlider() {
      const container = document.getElementById('monthPickerContainer');
      const now = new Date();
      const months = [];
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

      // Generate 12 months starting from current month going forward
      for (let i = 0; i < 12; i++) {
        const monthDate = new Date(now);
        monthDate.setMonth(monthDate.getMonth() + i);
        const monthIdx = monthDate.getMonth();
        const year = monthDate.getFullYear();
        months.push({
          value: i,
          label: monthNames[monthIdx],
          shortLabel: monthNames[monthIdx].substring(0, 3),
          year: year,
          date: monthDate
        });
      }

      const visibleMonths = months.slice(currentMonthOffset, currentMonthOffset + MONTHS_TO_SHOW);

      container.innerHTML = visibleMonths.map(m => {
        const isActive = selectedMonth === m.value;
        return `
          <button class="date-picker-btn ${isActive ? 'active' : ''}" data-month="${m.value}">
            <div style="font-weight: 700; font-size: 12px;">${m.shortLabel}</div>
            <div class="date-picker-date">${m.date.getFullYear()}</div>
          </button>
        `;
      }).join('');

      document.getElementById('prevMonthBtn').disabled = currentMonthOffset === 0;
      document.getElementById('nextMonthBtn').disabled = currentMonthOffset >= months.length - MONTHS_TO_SHOW;

      container.querySelectorAll('.date-picker-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedMonth = parseInt(btn.dataset.month);
          renderMonthSlider();
          loadLeaderboard('monthly', null, selectedMonth);
        });
      });
    }

    const prevPickWeekBtn = document.getElementById('prevPickWeekBtn');
    if (prevPickWeekBtn) {
      prevPickWeekBtn.addEventListener('click', () => {
        if (currentPickWeekOffset > 0) {
          currentPickWeekOffset--;
          renderPickWeekPicker();
        }
      });
    }

    const nextPickWeekBtn = document.getElementById('nextPickWeekBtn');
    if (nextPickWeekBtn) {
      nextPickWeekBtn.addEventListener('click', () => {
        if (currentPickWeekOffset < 20 - WEEKS_TO_SHOW) {
          currentPickWeekOffset++;
          renderPickWeekPicker();
        }
      });
    }

    document.getElementById('prevWeekBtn').addEventListener('click', () => {
      if (currentWeekOffset > 0) {
        currentWeekOffset--;
        renderWeekSlider();
      }
    });

    document.getElementById('nextWeekBtn').addEventListener('click', () => {
      if (currentWeekOffset < 20 - WEEKS_TO_SHOW) {
        currentWeekOffset++;
        renderWeekSlider();
      }
    });

    document.getElementById('prevMonthBtn').addEventListener('click', () => {
      if (currentMonthOffset > 0) {
        currentMonthOffset--;
        renderMonthSlider();
      }
    });

    document.getElementById('nextMonthBtn').addEventListener('click', () => {
      if (currentMonthOffset < 12 - MONTHS_TO_SHOW) {
        currentMonthOffset++;
        renderMonthSlider();
      }
    });

    // === Tabs ===
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(tabName).classList.add('active');
        
        if (tabName === 'daily-lb') {
          let selectedDate = document.getElementById('dailyLbDate').value;
          if (!selectedDate) {
            selectedDate = formatDateForComparison(new Date());
            document.getElementById('dailyLbDate').value = selectedDate;
            currentDailyDateOffset = PAST_DAYS;
          }
          renderDailyDatePicker();
          loadLeaderboard('daily', null, null, selectedDate);
        }
        if (tabName === 'weekly-lb') {
          renderWeekSlider();
          loadLeaderboard('weekly', selectedWeek);
        }
        if (tabName === 'monthly-lb') {
          renderMonthSlider();
          loadLeaderboard('monthly', null, selectedMonth);
        }
        if (tabName === 'winners') {
          loadPublicWinners();
        }
      });
    });

    // === Leaderboard Override ===
    const applyOverrideBtn = document.getElementById('applyOverrideBtn');
    if (applyOverrideBtn) {
      applyOverrideBtn.addEventListener('click', async () => {
        if (!checkAdminPermission()) return;
        
        const userEmail = document.getElementById('overrideUserEmail').value.trim();
        const date = document.getElementById('overrideDate').value;
        const score = document.getElementById('overrideScore').value;
        
        if (!userEmail || !date || score === '') {
          showMessage('Please fill in all fields', 'error', 'overrideMessage');
          return;
        }
        
        try {
          await db.collection('scoreOverrides').add({
            userEmail: userEmail,
            date: date,
            score: parseInt(score),
            timestamp: new Date(),
            appliedBy: auth.currentUser.email
          });
          
          document.getElementById('overrideUserEmail').value = '';
          document.getElementById('overrideDate').value = '';
          document.getElementById('overrideScore').value = '';
          
          showMessage('‚úÖ Score override applied successfully!', 'success', 'overrideMessage');
          loadOverrides();
        } catch (err) {
          console.error('Error applying override:', err);
          showMessage('‚ùå Failed to apply override: ' + err.message, 'error', 'overrideMessage');
        }
      });
    }

    async function loadOverrides() {
      try {
        const overridesSnapshot = await db.collection('scoreOverrides').orderBy('timestamp', 'desc').get();
        const overridesList = document.getElementById('overridesList');
        
        if (overridesSnapshot.empty) {
          overridesList.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: var(--muted); background: rgba(0,0,0,0.02); border-radius: 12px; border: 1px solid var(--border);">
              <p style="font-size: 24px; margin-bottom: 10px;">üìù</p>
              <p style="font-weight: 600; font-size: 0.9rem;">No overrides set</p>
            </div>
          `;
          return;
        }

        let html = '<div style="display: grid; gap: 1rem;">';
        overridesSnapshot.docs.forEach(doc => {
          const data = doc.data();
          html += `
            <div style="background: white; border: 2px solid var(--border); border-radius: 8px; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 700; color: var(--brand);">${data.userEmail}</div>
                <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px;">
                  Date: ${data.date} | Score: ${data.score} | Applied by: ${data.appliedBy}
                </div>
              </div>
              <button class="btn btn-secondary" onclick="deleteOverride('${doc.id}')" style="background: #fee; color: #e74c3c; border: 1px solid #e74c3c;">Delete</button>
            </div>
          `;
        });
        html += '</div>';
        overridesList.innerHTML = html;
      } catch (err) {
        console.error('Error loading overrides:', err);
      }
    }

    window.deleteOverride = async function(overrideId) {
      if (!checkAdminPermission()) return;
      if (!confirm('Are you sure you want to delete this override?')) return;
      
      try {
        await db.collection('scoreOverrides').doc(overrideId).delete();
        showMessage('‚úÖ Override deleted successfully!', 'success', 'overrideMessage');
        loadOverrides();
      } catch (err) {
        console.error('Error deleting override:', err);
        showMessage('‚ùå Failed to delete override: ' + err.message, 'error', 'overrideMessage');
      }
    };

    // === Winners Management ===
    const adminAddWinnerBtn = document.getElementById('adminAddWinnerBtn');
    if (adminAddWinnerBtn) {
      adminAddWinnerBtn.addEventListener('click', async () => {
        if (!checkAdminPermission()) return;
        
        const week = document.getElementById('adminWinnersWeek').value.trim();
        const username = document.getElementById('adminWinnersUsername').value.trim();
        const score = document.getElementById('adminWinnersScore').value;
        
        if (!week || !username || !score) {
          showMessage('Please fill in all fields', 'error', 'adminWinnersMessage');
          return;
        }
        
        try {
          await db.collection('winners').add({
            week: week,
            username: username,
            score: parseInt(score),
            timestamp: new Date()
          });
          
          document.getElementById('adminWinnersWeek').value = '';
          document.getElementById('adminWinnersUsername').value = '';
          document.getElementById('adminWinnersScore').value = '';
          
          showMessage('‚úÖ Winner added successfully!', 'success', 'adminWinnersMessage');
          loadWinners();
          loadPublicWinners();
        } catch (err) {
          console.error('Error adding winner:', err);
          showMessage('‚ùå Failed to add winner: ' + err.message, 'error', 'adminWinnersMessage');
        }
      });
    }

    async function loadWinners() {
      try {
        const winnersSnapshot = await db.collection('winners').orderBy('timestamp', 'desc').get();
        const winnersTable = document.getElementById('adminWinnersTable');
        const winnersBody = document.getElementById('adminWinnersTableBody');
        const noWinnersMsg = document.getElementById('noWinnersMessage');
        
        if (winnersSnapshot.empty) {
          winnersTable.style.display = 'none';
          noWinnersMsg.style.display = 'block';
          return;
        }
        
        winnersTable.style.display = 'table';
        noWinnersMsg.style.display = 'none';
        winnersBody.innerHTML = '';
        
        winnersSnapshot.docs.forEach(doc => {
          const data = doc.data();
          const row = winnersBody.insertRow();
          row.innerHTML = `
            <td style="padding: 14px; border-bottom: 1px solid var(--border);">${data.week}</td>
            <td style="padding: 14px; border-bottom: 1px solid var(--border);">${data.username}</td>
            <td style="padding: 14px; text-align: center; border-bottom: 1px solid var(--border);">${data.score}</td>
            <td style="padding: 14px; text-align: center; border-bottom: 1px solid var(--border);">
              <button class="admin-delete-btn" style="padding: 6px 12px; font-size: 13px;" onclick="deleteWinner('${doc.id}')">Delete</button>
            </td>
          `;
        });
      } catch (err) {
        console.error('Error loading winners:', err);
      }
    }

    async function deleteWinner(winnerId) {
      if (!checkAdminPermission()) return;
      
      if (!confirm('Are you sure you want to delete this winner?')) return;
      
      try {
        await db.collection('winners').doc(winnerId).delete();
        showMessage('‚úÖ Winner deleted successfully!', 'success', 'adminWinnersMessage');
        loadWinners();
        loadPublicWinners();
      } catch (err) {
        console.error('Error deleting winner:', err);
        showMessage('‚ùå Failed to delete winner: ' + err.message, 'error', 'adminWinnersMessage');
      }
    }

    async function loadPublicWinners() {
      try {
        const winnersSnapshot = await db.collection('winners').orderBy('timestamp', 'desc').get();
        const winnersBody = document.getElementById('publicWinnersTableBody');
        
        if (winnersSnapshot.empty) {
          winnersBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 3rem 2rem; color: var(--muted);">No winners yet</td></tr>';
          return;
        }
        
        winnersBody.innerHTML = '';
        winnersSnapshot.docs.forEach(doc => {
          const data = doc.data();
          const row = winnersBody.insertRow();
          row.innerHTML = `
            <td style="padding: 14px; border-bottom: 1px solid var(--border);">${data.week}</td>
            <td style="padding: 14px; border-bottom: 1px solid var(--border);">${data.username}</td>
            <td style="padding: 14px; text-align: center; border-bottom: 1px solid var(--border);">${data.score}</td>
          `;
        });
      } catch (err) {
        console.error('Error loading public winners:', err);
      }
    }

    // === Leaderboard Refresh Buttons ===
    const dailyRefreshBtn = document.getElementById('refreshDailyBtn');
    const weeklyRefreshBtn = document.getElementById('refreshWeeklyBtn');
    const monthlyRefreshBtn = document.getElementById('refreshMonthlyBtn');
    
    if (!dailyRefreshBtn) console.error('‚ùå refreshDailyBtn not found!');
    if (!weeklyRefreshBtn) console.error('‚ùå refreshWeeklyBtn not found!');
    if (!monthlyRefreshBtn) console.error('‚ùå refreshMonthlyBtn not found!');
    
    if (dailyRefreshBtn) {
      dailyRefreshBtn.addEventListener('click', async () => {
        console.log('üîÑ User clicked refresh Daily leaderboard');
        const originalText = dailyRefreshBtn.textContent;
        const selectedDate = document.getElementById('dailyLbDate').value;
        dailyRefreshBtn.disabled = true;
        dailyRefreshBtn.textContent = 'Loading...';
        try {
          await loadLeaderboard('daily', null, null, selectedDate);
          console.log('‚úÖ Daily leaderboard refreshed successfully');
          dailyRefreshBtn.textContent = 'Refreshed! ‚úì';
          setTimeout(() => {
            dailyRefreshBtn.textContent = originalText;
            dailyRefreshBtn.disabled = false;
          }, 2000);
        } catch (err) {
          console.error('Error refreshing daily leaderboard:', err);
          dailyRefreshBtn.textContent = 'Error - Try Again';
          dailyRefreshBtn.disabled = false;
          showMessage('‚ùå Failed to refresh daily leaderboard. Check console for details.', 'error');
        }
      });
      console.log('‚úÖ Daily refresh button listener attached');
    }

    if (weeklyRefreshBtn) {
      weeklyRefreshBtn.addEventListener('click', async () => {
        console.log('üîÑ User clicked refresh Weekly leaderboard');
        const originalText = weeklyRefreshBtn.textContent;
        weeklyRefreshBtn.disabled = true;
        weeklyRefreshBtn.textContent = 'Loading...';
        try {
          // Get the currently selected week from the active button in the week picker
          const activeWeekBtn = document.querySelector('#weekPickerContainer .date-picker-btn.active');
          let currentWeek = selectedWeek;
          if (activeWeekBtn) {
            currentWeek = parseInt(activeWeekBtn.dataset.week);
          }
          console.log(`üîÑ Refreshing weekly leaderboard for week: ${currentWeek}`);
          await loadLeaderboard('weekly', currentWeek);
          console.log('‚úÖ Weekly leaderboard refreshed successfully');
          weeklyRefreshBtn.textContent = 'Refreshed! ‚úì';
          setTimeout(() => {
            weeklyRefreshBtn.textContent = originalText;
            weeklyRefreshBtn.disabled = false;
          }, 2000);
        } catch (err) {
          console.error('Error refreshing weekly leaderboard:', err);
          weeklyRefreshBtn.textContent = 'Error - Try Again';
          weeklyRefreshBtn.disabled = false;
          showMessage('‚ùå Failed to refresh weekly leaderboard. Check console for details.', 'error');
        }
      });
      console.log('‚úÖ Weekly refresh button listener attached');
    }

    if (monthlyRefreshBtn) {
      monthlyRefreshBtn.addEventListener('click', async () => {
        console.log('üîÑ User clicked refresh Monthly leaderboard');
        const originalText = monthlyRefreshBtn.textContent;
        monthlyRefreshBtn.disabled = true;
        monthlyRefreshBtn.textContent = 'Loading...';
        try {
          await loadLeaderboard('monthly', null, selectedMonth);
          console.log('‚úÖ Monthly leaderboard refreshed successfully');
          monthlyRefreshBtn.textContent = 'Refreshed! ‚úì';
          setTimeout(() => {
            monthlyRefreshBtn.textContent = originalText;
            monthlyRefreshBtn.disabled = false;
          }, 2000);
        } catch (err) {
          console.error('Error refreshing monthly leaderboard:', err);
          monthlyRefreshBtn.textContent = 'Error - Try Again';
          monthlyRefreshBtn.disabled = false;
          showMessage('‚ùå Failed to refresh monthly leaderboard. Check console for details.', 'error');
        }
      });
      console.log('‚úÖ Monthly refresh button listener attached');
    }

    async function loadLeaderboard(period, weekNumber = null, monthOffset = null, selectedDate = null) {
      try {
        console.log(`loadLeaderboard called for period: ${period}, weekNumber: ${weekNumber}, monthOffset: ${monthOffset}, selectedDate: ${selectedDate}`);
        
        if (period === 'daily') {
          const dateToUse = selectedDate || formatDateForComparison(new Date());
          console.log(`üìÖ DAILY leaderboard for date: ${dateToUse}`);
          console.log(`  üîç [CHECK] Looking for questions, picks, and answers for this date...`);
          
          const chk1 = await db.collection('questions').where('date', '==', dateToUse).get();
          const chk2 = await db.collection('picks').where('date', '==', dateToUse).get();
          const chk3 = await db.collection('correctAnswers').where('date', '==', dateToUse).get();
          console.log(`  üìä Questions: ${chk1.size}, Picks: ${chk2.size}, Answers: ${chk3.size}`);
          
          const dailyScores = await calculateScoresForDate(dateToUse, null);
          console.log(`  üéØ Got ${dailyScores.length} scores from calculateScoresForDate:`, dailyScores);
          const leaderboard = dailyScores.map(score => ({
            username: score.username,
            correct_count: score.correct,
            total_count: score.total,
            isOverridden: score.isOverridden
          }));
          
          console.log(`  üìä Final leaderboard for daily: ${leaderboard.length} users`);
          renderLeaderboard(period, leaderboard);
          return;
        }
        
        if (period === 'weekly') {
          if (weekNumber === null || weekNumber === undefined) {
            console.warn('‚ö†Ô∏è No week number provided for weekly leaderboard');
            renderLeaderboard(period, []);
            return;
          }
          
          console.log(`üìÖ WEEKLY leaderboard for Week ${weekNumber}`);
          
          const questionsSnapshot = await db.collection('questions').get();
          const datesWithWeek = new Set();
          
          questionsSnapshot.docs.forEach(doc => {
            const data = doc.data();
            const items = data.items || [];
            const hasWeekQuestions = items.some(q => q.weekNumber === weekNumber || q.weekNumber == weekNumber);
            if (hasWeekQuestions) {
              datesWithWeek.add(data.date);
            }
          });
          
          console.log(`  üìÖ Found ${datesWithWeek.size} dates with Week ${weekNumber} questions: [${Array.from(datesWithWeek).join(', ')}]`);
          
          if (datesWithWeek.size === 0) {
            console.warn(`  ‚ö†Ô∏è No questions found for Week ${weekNumber}`);
            renderLeaderboard(period, []);
            return;
          }
          
          const userScoresMap = {};
          for (const date of datesWithWeek) {
            console.log(`  üîÑ Calculating scores for date: ${date} (Week ${weekNumber} questions only)`);
            const dailyScores = await calculateScoresForDate(date, weekNumber);
            console.log(`    ‚û°Ô∏è Got ${dailyScores.length} users with scores for ${date}`);
            
            dailyScores.forEach(dayScore => {
              if (!userScoresMap[dayScore.username]) {
                userScoresMap[dayScore.username] = {
                  username: dayScore.username,
                  totalCorrect: 0,
                  totalQuestions: 0
                };
              }
              userScoresMap[dayScore.username].totalCorrect += dayScore.correct;
              userScoresMap[dayScore.username].totalQuestions += dayScore.total;
              console.log(`    ${dayScore.username}: ${dayScore.correct}/${dayScore.total} (running total: ${userScoresMap[dayScore.username].totalCorrect}/${userScoresMap[dayScore.username].totalQuestions})`);
            });
          }
          
          const leaderboard = Object.values(userScoresMap)
            .map(score => ({
              username: score.username,
              correct_count: score.totalCorrect,
              total_count: score.totalQuestions
            }))
            .sort((a, b) => b.correct_count - a.correct_count);
          
          console.log(`Weekly leaderboard final: ${leaderboard.length} users, top score: ${leaderboard[0]?.correct_count || 0}`);
          renderLeaderboard(period, leaderboard);
          return;
        }
        
        if (period === 'monthly') {
          const now = new Date();
          let startDate, endDate;
          
          if (monthOffset !== null && monthOffset !== undefined) {
            const targetMonth = new Date(now);
            targetMonth.setMonth(now.getMonth() + monthOffset);
            startDate = new Date(targetMonth.getFullYear(), targetMonth.getMonth(), 1);
            endDate = new Date(targetMonth.getFullYear(), targetMonth.getMonth() + 1, 0);
          } else {
            startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          }
          
          const startDateStr = formatDateForComparison(startDate);
          const endDateStr = formatDateForComparison(endDate);
          console.log(`üìÖ MONTHLY leaderboard: date range ${startDateStr} to ${endDateStr}`);
          
          const picksSnapshot = await db.collection('picks').get();
          console.log(`  üì¶ Total picks in database: ${picksSnapshot.size}`);
          
          if (picksSnapshot.empty) {
            console.warn(`  ‚ö†Ô∏è No picks found in database for monthly leaderboard`);
            renderLeaderboard(period, []);
            return;
          }
          
          const datesInRange = new Set();
          picksSnapshot.docs.forEach(doc => {
            const pickDate = doc.data().date;
            if (pickDate >= startDateStr && pickDate <= endDateStr) {
              datesInRange.add(pickDate);
            }
          });
          
          console.log(`  üìÖ Found ${datesInRange.size} dates with picks in range: [${Array.from(datesInRange).join(', ')}]`);
          
          const userScoresMap = {};
          for (const date of datesInRange) {
            console.log(`  üîÑ Calculating scores for date: ${date}`);
            const dailyScores = await calculateScoresForDate(date, null);
            console.log(`    ‚û°Ô∏è Got ${dailyScores.length} users with scores for ${date}`);
            
            dailyScores.forEach(dayScore => {
              if (!userScoresMap[dayScore.username]) {
                userScoresMap[dayScore.username] = {
                  username: dayScore.username,
                  totalCorrect: 0,
                  totalQuestions: 0
                };
              }
              userScoresMap[dayScore.username].totalCorrect += dayScore.correct;
              userScoresMap[dayScore.username].totalQuestions += dayScore.total;
              console.log(`    ${dayScore.username}: ${dayScore.correct}/${dayScore.total} (running total: ${userScoresMap[dayScore.username].totalCorrect}/${userScoresMap[dayScore.username].totalQuestions})`);
            });
          }
          
          const leaderboard = Object.values(userScoresMap)
            .map(score => ({
              username: score.username,
              correct_count: score.totalCorrect,
              total_count: score.totalQuestions
            }))
            .sort((a, b) => b.correct_count - a.correct_count);
          
          console.log(`Monthly leaderboard final: ${leaderboard.length} users, top score: ${leaderboard[0]?.correct_count || 0}`);
          renderLeaderboard(period, leaderboard);
          return;
        }
      } catch (err) {
        console.error('Error loading leaderboard:', err);
        showMessage(`Failed to load ${period} leaderboard`, 'error');
      }
    }

    function renderLeaderboard(period, entries) {
      const bodyId = `${period}LeaderboardBody`;
      
      console.log(`üéØ Rendering ${period} leaderboard with ${entries.length} entries`);
      if (entries.length === 0) {
        console.warn(`‚ö†Ô∏è ${period} leaderboard empty`);
      }

      const medals = ['ü•á', 'ü•à', 'ü•â'];
      const bodyHtml = entries.map((entry, idx) => {
        let badge = '';
        if (idx < 3) {
          badge = `<span class="rank-badge rank-${idx + 1}">${medals[idx]}</span>`;
        }
        const overrideIndicator = entry.isOverridden ? ' <span style="color: #f39c12; font-size: 0.8rem;" title="Score manually adjusted">üîß</span>' : '';
        console.log(`  ${idx + 1}. ${entry.username}: ${entry.correct_count}${entry.isOverridden ? ' (overridden)' : ''}`);
        return `
          <tr>
            <td>${badge}${idx + 1}</td>
            <td>${entry.username}${overrideIndicator}</td>
            <td><span class="score">${entry.correct_count}</span></td>
          </tr>
        `;
      }).join('');

      if (entries.length === 0) {
        console.warn(`‚ö†Ô∏è  No entries to display for ${period} leaderboard`);
      }
      
      document.getElementById(bodyId).innerHTML = bodyHtml || '<tr><td colspan="3" class="empty-state">No data yet</td></tr>';
    }

    // === Utility ===
    function showMessage(text, type = 'info', elementId = 'message') {
      const msg = document.getElementById(elementId);
      if (!msg) return;
      msg.textContent = text;
      msg.className = `message show ${type}`;
      console.log(`[${type.toUpperCase()}] ${text}`);
      // Auto-hide after 5 seconds (increased from 4s for better UX)
      setTimeout(() => msg.classList.remove('show'), 5000);
    }

    // === Init ===
    // initAuth is now called from initializeFirebase() after Firebase is ready
    
    // Debug function - call from console to check data
    window.debugLeaderboardData = async function(dateStr) {
      if (!dateStr) dateStr = formatDateForComparison(new Date());
      console.log(`\nüîç DEBUG LEADERBOARD DATA FOR: ${dateStr}\n`);
      
      const q = await db.collection('questions').where('date', '==', dateStr).get();
      console.log(`Questions: ${q.size} docs`);
      if (!q.empty) {
        const items = q.docs[0].data().items || [];
        console.log(`  - ${items.length} items in questions`);
      }
      
      const a = await db.collection('correctAnswers').where('date', '==', dateStr).get();
      console.log(`Correct Answers: ${a.size} docs`);
      if (!a.empty) {
        const answers = a.docs[0].data().answers || [];
        console.log(`  - ${answers.length} answers`);
        answers.forEach(ans => console.log(`    Q${ans.questionId}: ${ans.correctAnswer}`));
      }
      
      const p = await db.collection('picks').where('date', '==', dateStr).get();
      console.log(`User Picks: ${p.size} docs`);
      p.forEach(doc => {
        const picks = doc.data();
        console.log(`  - User: ${picks.username}, ${picks.answers.length} answers`);
      });
      
      console.log(`\n‚ö†Ô∏è If any of these is 0, leaderboard will be empty!\n`);
    };
    
    // Initialize leaderboard pickers when app first shows
    function initializeLeaderboardPickers() {
      console.log('üöÄ Initializing leaderboard pickers');
      try {
        console.log('üìÖ Rendering daily date picker');
        renderDailyDatePicker();
      } catch (err) {
        console.error('‚ùå Error rendering daily date picker:', err);
      }
      try {
        console.log('üìÖ Rendering week slider');
        renderWeekSlider();
      } catch (err) {
        console.error('‚ùå Error rendering week slider:', err);
      }
      try {
        console.log('üìÖ Rendering month slider');
        renderMonthSlider();
      } catch (err) {
        console.error('‚ùå Error rendering month slider:', err);
      }
    }
  </script>
</body>
</html>
